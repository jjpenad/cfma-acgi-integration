<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACGI to HubSpot - Field Mapping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 98vw;
            margin: 1.5rem auto;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            color: #333;
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }

        .form-section h3 {
            color: #333;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .form-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .nav-tabs {
            border-bottom: 2px solid #dee2e6;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            margin-right: 0.5rem;
            color: #6c757d;
            font-weight: 600;
        }

        .nav-tabs .nav-link.active {
            background: #667eea;
            color: white;
        }

        .property-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .property-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .property-card.important {
            border-color: #28a745;
            background: #f8fff9;
        }

        .property-card.enabled {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .property-card.sortable-ghost {
            opacity: 0.5;
            background: #e9ecef;
        }

        .property-card.sortable-chosen {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transform: rotate(2deg);
        }

        .drag-handle {
            transition: color 0.2s ease;
        }

        .drag-handle:hover {
            color: #667eea !important;
        }

        .property-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .property-name {
            font-weight: 600;
            color: #333;
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
            vertical-align: middle;
        }

        .property-label {
            color: #666;
            font-size: 0.9rem;
            word-break: break-all;
            white-space: pre-wrap;
            max-height: 120px;
            overflow: auto;
        }

        .property-type {
            background: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        .property-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            align-items: center;
            justify-content: flex-end;
            min-width: 80px;
        }

        @media (max-width: 600px) {
            .property-actions {
                flex-direction: column;
                align-items: flex-end;
            }
        }

        .property-card .btn-group {
            flex-shrink: 0;
        }

        .form-check {
            margin-bottom: 0.5rem;
        }

        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }

        .loading {
            display: none;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }

        .alert {
            border-radius: 10px;
            border: none;
            margin-bottom: 1rem;
        }

        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .badge-important {
            background: #28a745;
        }

        .badge-enabled {
            background: #667eea;
        }

        .form-row {
            margin-bottom: 1rem;
        }

        .form-row label {
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .form-row input,
        .form-row select,
        .form-row textarea {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 0.5rem;
            transition: all 0.3s ease;
        }

        .form-row input:focus,
        .form-row select:focus,
        .form-row textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        /* Output area styling */
        #contactsOutput,
        #dealsOutput {
            border-top: 1px solid #e9ecef;
            padding-top: 1rem;
        }

        #contactsOutput h6,
        #dealsOutput h6 {
            color: #495057;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        #contactsOutputContent,
        #dealsOutputContent {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            word-break: break-word;
        }

        #contactsOutputContent pre,
        #dealsOutputContent pre {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.8rem;
            overflow-x: auto;
        }

        .user-info {
            background: #e9ecef;
            border-radius: 10px;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info .user-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info .user-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- User Info Bar -->
            <div class="user-info">
                <div class="user-details">
                    <i class="fas fa-user-circle"></i>
                    <span>Welcome, <strong>{{ username }}</strong></span>
                </div>
                <div class="user-actions">
                    <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>

            <div class="header">
                <h1><i class="fas fa-sync-alt"></i> ACGI to HubSpot Field Mapping</h1>
                <p>Configure and map ACGI fields to HubSpot properties</p>
            </div>
            <div id="statusMessages"></div>

            <!-- Navigation -->
            <nav class="mb-4">
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-sync-alt"></i> Integration</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/acgi-to-hubspot"><i class="fas fa-cogs"></i> ACGI to
                            HubSpot</a>
                    </li>
                </ul>
            </nav>

            <!-- Object Type Tabs -->
            <ul class="nav nav-tabs" id="objectTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts"
                        type="button" role="tab">
                        <i class="fas fa-user"></i> Contacts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="memberships-tab" data-bs-toggle="tab" data-bs-target="#memberships"
                        type="button" role="tab">
                        <i class="fas fa-users"></i> Memberships
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="purchased-products-tab" data-bs-toggle="tab" data-bs-target="#purchased-products"
                        type="button" role="tab">
                        <i class="fas fa-shopping-cart"></i> Orders
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="events-tab" data-bs-toggle="tab" data-bs-target="#events"
                        type="button" role="tab">
                        <i class="fas fa-calendar-alt"></i> Events
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="objectTabContent">
                <!-- Contacts Tab -->
                <div class="tab-pane fade show active" id="contacts" role="tabpanel">
                    <div class="mt-4">
                        <div class="row">
                            <div class="d-flex justify-content-center">
                                <button id="copyToHubspotBtn" class="btn btn-outline-primary btn-sm mb-2"
                                    style="width: 10rem;">
                                    <i class="fas fa-arrow-right"></i> Copy To HubSpot
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <!-- COLUMN 1: ACGI Fetch & JSON Viewer (with Address Preferences under Fetch button) -->
                            <div class="col-md-3 mb-4">
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-database"></i> ACGI Contact Data
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="acgi-customer-id">ACGI Customer ID:</label>
                                            <input type="text" id="acgi-customer-id" class="form-control" />
                                            <button id="fetch-acgi-btn" class="btn btn-primary mt-2 w-100"
                                                onclick="fetchAcgiCustomer()">Fetch</button>
                                            <div id="acgi-loading-spinner" class="text-center my-2"
                                                style="display:none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <div>Loading customer data...</div>
                                            </div>
                                        </div>
                                        <!-- Address Preferences Section -->
                                        <div class="card mt-3">
                                            <div class="card-header bg-info text-white">
                                                <i class="fas fa-cog"></i> Address Preferences
                                            </div>
                                            <div class="card-body">
                                                <form id="address-preferences-form">
                                                    <div class="mb-2">
                                                        <div class="form-label fw-bold mb-1">Selection Preferences</div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="addressPreferenceMode" id="addressModeFirst"
                                                                value="first" checked>
                                                            <label class="form-check-label"
                                                                for="addressModeFirst">Select first</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="addressPreferenceMode" id="addressModeLast"
                                                                value="last">
                                                            <label class="form-check-label" for="addressModeLast">Select
                                                                last</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="addressPreferenceMode" id="addressModeCriteria"
                                                                value="criteria">
                                                            <label class="form-check-label"
                                                                for="addressModeCriteria">Select by criteria</label>
                                                        </div>
                                                    </div>
                                                    <div id="address-criteria-section" style="display:none;">
                                                        <div class="mb-2">
                                                            <label class="form-label">Property:</label>
                                                            <select class="form-select" id="address-criteria-property"
                                                                name="property"></select>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label class="form-label">Operator:</label>
                                                            <select class="form-select" id="address-criteria-operator"
                                                                name="operator">
                                                                <option value="=">=</option>
                                                                <option value="!=">!=</option>
                                                                <option value="contains">contains</option>
                                                                <option value=">">&gt;</option>
                                                                <option value="<">&lt;</option>
                                                                <option value="is null">is null</option>
                                                                <option value="is not null">is not null</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-2" id="address-criteria-value-group">
                                                            <label class="form-label">Value:</label>
                                                            <input type="text" class="form-control"
                                                                id="address-criteria-value" name="value" />
                                                        </div>
                                                    </div>
                                                    <div class="mb-2 mt-3">
                                                        <div class="form-label fw-bold mb-1">Format Preferences</div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="addressFormat" id="addressFormatJson" value="json"
                                                                checked>
                                                            <label class="form-check-label" for="addressFormatJson">As
                                                                JSON</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="addressFormat" id="addressFormatFlat"
                                                                value="flat">
                                                            <label class="form-check-label"
                                                                for="addressFormatFlat">Flat</label>
                                                        </div>
                                                    </div>
                                                    <button type="submit"
                                                        class="btn btn-outline-info btn-sm w-100 mt-2">
                                                        <i class="fas fa-save"></i> Save Preference
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        <!-- Email Preferences Section -->
                                        <div class="card mt-3">
                                            <div class="card-header bg-info text-white">
                                                <i class="fas fa-envelope"></i> Email Preferences
                                            </div>
                                            <div class="card-body">
                                                <form id="email-preferences-form">
                                                    <div class="mb-2">
                                                        <div class="form-label fw-bold mb-1">Selection Preferences</div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="emailPreferenceMode" id="emailModeFirst"
                                                                value="first" checked>
                                                            <label class="form-check-label" for="emailModeFirst">Select
                                                                first</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="emailPreferenceMode" id="emailModeLast"
                                                                value="last">
                                                            <label class="form-check-label" for="emailModeLast">Select
                                                                last</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="emailPreferenceMode" id="emailModeCriteria"
                                                                value="criteria">
                                                            <label class="form-check-label"
                                                                for="emailModeCriteria">Select by criteria</label>
                                                        </div>
                                                    </div>
                                                    <div id="email-criteria-section" style="display:none;">
                                                        <div class="mb-2">
                                                            <label class="form-label">Property:</label>
                                                            <select class="form-select" id="email-criteria-property"
                                                                name="property"></select>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label class="form-label">Operator:</label>
                                                            <select class="form-select" id="email-criteria-operator"
                                                                name="operator">
                                                                <option value="=">=</option>
                                                                <option value="!=">!=</option>
                                                                <option value="contains">contains</option>
                                                                <option value=">">&gt;</option>
                                                                <option value="<">&lt;</option>
                                                                <option value="is null">is null</option>
                                                                <option value="is not null">is not null</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-2" id="email-criteria-value-group">
                                                            <label class="form-label">Value:</label>
                                                            <input type="text" class="form-control"
                                                                id="email-criteria-value" name="value" />
                                                        </div>
                                                    </div>
                                                    <div class="mb-2 mt-3">
                                                        <div class="form-label fw-bold mb-1">Format Preferences</div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="emailFormat" id="emailFormatJson" value="json"
                                                                checked>
                                                            <label class="form-check-label" for="emailFormatJson">As
                                                                JSON</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="emailFormat" id="emailFormatFlat" value="flat">
                                                            <label class="form-check-label"
                                                                for="emailFormatFlat">Flat</label>
                                                        </div>
                                                    </div>
                                                    <button type="submit"
                                                        class="btn btn-outline-info btn-sm w-100 mt-2">
                                                        <i class="fas fa-save"></i> Save Preference
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        <!-- Phone Preferences Section -->
                                        <div class="card mt-3">
                                            <div class="card-header bg-info text-white">
                                                <i class="fas fa-phone"></i> Phone Preferences
                                            </div>
                                            <div class="card-body">
                                                <form id="phone-preferences-form">
                                                    <div class="mb-2">
                                                        <div class="form-label fw-bold mb-1">Selection Preferences</div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="phonePreferenceMode" id="phoneModeFirst"
                                                                value="first" checked>
                                                            <label class="form-check-label" for="phoneModeFirst">Select
                                                                first</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="phonePreferenceMode" id="phoneModeLast"
                                                                value="last">
                                                            <label class="form-check-label" for="phoneModeLast">Select
                                                                last</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="phonePreferenceMode" id="phoneModeCriteria"
                                                                value="criteria">
                                                            <label class="form-check-label"
                                                                for="phoneModeCriteria">Select by criteria</label>
                                                        </div>
                                                    </div>
                                                    <div id="phone-criteria-section" style="display:none;">
                                                        <div class="mb-2">
                                                            <label class="form-label">Property:</label>
                                                            <select class="form-select" id="phone-criteria-property"
                                                                name="property"></select>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label class="form-label">Operator:</label>
                                                            <select class="form-select" id="phone-criteria-operator"
                                                                name="operator">
                                                                <option value="=">=</option>
                                                                <option value="!=">!=</option>
                                                                <option value="contains">contains</option>
                                                                <option value=">">&gt;</option>
                                                                <option value="<">&lt;</option>
                                                                <option value="is null">is null</option>
                                                                <option value="is not null">is not null</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-2" id="phone-criteria-value-group">
                                                            <label class="form-label">Value:</label>
                                                            <input type="text" class="form-control"
                                                                id="phone-criteria-value" name="value" />
                                                        </div>
                                                    </div>
                                                    <div class="mb-2 mt-3">
                                                        <div class="form-label fw-bold mb-1">Format Preferences</div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="phoneFormat" id="phoneFormatJson" value="json"
                                                                checked>
                                                            <label class="form-check-label" for="phoneFormatJson">As
                                                                JSON</label>
                                                        </div>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="radio"
                                                                name="phoneFormat" id="phoneFormatFlat" value="flat">
                                                            <label class="form-check-label"
                                                                for="phoneFormatFlat">Flat</label>
                                                        </div>
                                                    </div>
                                                    <button type="submit"
                                                        class="btn btn-outline-info btn-sm w-100 mt-2">
                                                        <i class="fas fa-save"></i> Save Preference
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <label class="form-label">Fetched Data (JSON):</label>
                                            <pre id="acgi-json-viewer"
                                                style="background:#f8f9fa; border-radius:8px; padding:1em; min-height:120px; max-height:300px; overflow:auto; font-size:0.9em;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 2: ACGI Fields List (with Important/All Available sections, no card box) -->
                            <div class="col-md-3 mb-4">

                                <h4><i class="fas fa-star"></i> Important Fields</h4>
                                <div id="acgiImportantFields" class="mb-4">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="acgiAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No fields loaded
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 3: HubSpot Properties -->
                            <div class="col-md-3">
                                <h4><i class="fas fa-star"></i> Important Fields</h4>
                                <div id="contactsImportantFields" class="mb-4">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="contactsAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see all available fields
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 4: Save to HubSpot & Search Preference -->
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-save"></i> Save to HubSpot
                                    </div>
                                    <div class="card-body">
                                        <div id="contactsForm">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-info-circle"></i> Load properties to see the form
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success w-100 mb-2"
                                                onclick="saveToHubSpot('contacts')">
                                                <i class="fas fa-save"></i> Save to HubSpot
                                            </button>
                                            <button type="button" class="btn btn-warning w-100 mb-3"
                                                onclick="resetForm('contacts')">
                                                <i class="fas fa-undo"></i> Reset Form
                                            </button>
                                            <!-- Search Preference Section -->
                                            <div class="card mt-3">
                                                <div class="card-header bg-info text-white">
                                                    <i class="fas fa-search"></i> Search Preference
                                                </div>
                                                <div class="card-body">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio"
                                                            name="contactsSearchPreference" id="contactsEmailOnly"
                                                            value="email_only" checked>
                                                        <label class="form-check-label" for="contactsEmailOnly">
                                                            Search by email only
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio"
                                                            name="contactsSearchPreference" id="contactsCustomerIdOnly"
                                                            value="customer_id_only">
                                                        <label class="form-check-label" for="contactsCustomerIdOnly">
                                                            Search by customer_id only
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio"
                                                            name="contactsSearchPreference"
                                                            id="contactsEmailThenCustomerId"
                                                            value="email_then_customer_id">
                                                        <label class="form-check-label"
                                                            for="contactsEmailThenCustomerId">
                                                            Search by email and then customer_id
                                                        </label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio"
                                                            name="contactsSearchPreference"
                                                            id="contactsCustomerIdThenEmail"
                                                            value="customer_id_then_email">
                                                        <label class="form-check-label"
                                                            for="contactsCustomerIdThenEmail">
                                                            Search by customer_id and then email
                                                        </label>
                                                    </div>
                                                    <button type="button" class="btn btn-outline-info btn-sm mt-2"
                                                        onclick="saveSearchPreference('contacts')">
                                                        <i class="fas fa-save"></i> Save Preference
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="contactsOutput" class="mt-3" style="display: none;">
                                            <h6><i class="fas fa-terminal"></i> Output:</h6>
                                            <div class="alert alert-info" id="contactsOutputContent">
                                                <!-- Output will be displayed here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Memberships Tab -->
                <div class="tab-pane fade" id="memberships" role="tabpanel">
                    <div class="mt-4">
                        <div class="row">
                            <div class="d-flex justify-content-center">
                                <button id="copyMembershipsToHubspotBtn" class="btn btn-outline-primary btn-sm mb-2"
                                    style="width: 10rem;">
                                    <i class="fas fa-arrow-right"></i> Copy To HubSpot
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <!-- COLUMN 1: Fetch Memberships -->
                            <div class="col-md-3 mb-4">
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-database"></i> ACGI Membership Data
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="acgi-membership-customer-id">ACGI Customer ID:</label>
                                            <input type="text" id="acgi-membership-customer-id" class="form-control" />
                                            <button id="fetch-memberships-btn"
                                                class="btn btn-primary mt-2 w-100" onclick="fetchAcgiCustomerMemberships()">Fetch</button>
                                            <div id="acgi-membership-loading-spinner" class="text-center my-2"
                                                style="display:none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <div>Loading memberships...</div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="mb-2" id="membership-selector-container" style="display: none;">
                                                <label class="form-label">Select Membership Item:</label>
                                                <select class="form-select" id="membership-item-selector">
                                                    <option value="">Loading...</option>
                                                </select>
                                            </div>
                                            <label class="form-label">Fetched Data (JSON):</label>
                                            <pre id="acgi-memberships-json-viewer"
                                                style="background:#f8f9fa; border-radius:8px; padding:1em; min-height:120px; max-height:300px; overflow:auto; font-size:0.9em;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 2: Important Fields from First Membership -->
                            <div class="col-md-3 mb-4">
                                <h4><i class="fas fa-star"></i> Important Fields</h4>
                                <div id="membershipACGIImportantFields" class="mb-4">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="membershipACGIAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No fields loaded
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 3: Mapping UI -->
                            <div class="col-md-3">
                                <h4><i class="fas fa-link"></i> Map to HubSpot Fields</h4>
                                <div id="membershipsImportantFields" class="mb-4"> 
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="membershipsAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see all available fields
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 4: HubSpot Form for Custom Object -->
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-save"></i> Save to HubSpot (ACGI Memberships)
                                    </div>
                                    <div class="card-body">
                                        <div id="membershipsForm">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-info-circle"></i> Load properties to see the form
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success w-100 mb-2"
                                                onclick="saveToHubSpot('memberships')">
                                                <i class="fas fa-save"></i> Save to HubSpot
                                            </button>
                                            <button type="button" class="btn btn-warning w-100 mb-3"
                                                onclick="resetForm('memberships')">
                                                <i class="fas fa-undo"></i> Reset Form
                                            </button>
                                        </div>
                                        <div id="membershipsOutput" class="mt-3" style="display: none;">
                                            <h6><i class="fas fa-terminal"></i> Output:</h6>
                                            <div class="alert alert-info" id="membershipsOutputContent">
                                                <!-- Output will be displayed here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Purchased Products Tab -->
                <div class="tab-pane fade" id="purchased-products" role="tabpanel">
                    <div class="mt-4">
                        <div class="row">
                            <div class="d-flex justify-content-center">
                                <button id="copyOrdersToHubspotBtn" class="btn btn-outline-primary btn-sm mb-2"
                                    style="width: 10rem;">
                                    <i class="fas fa-arrow-right"></i> Copy To HubSpot
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <!-- COLUMN 1: Fetch Purchased Products -->
                            <div class="col-md-3 mb-4">
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-database"></i> ACGI Orders Data
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="acgi-products-customer-id">ACGI Customer ID:</label>
                                            <input type="text" id="acgi-products-customer-id" class="form-control" />
                                            <button id="fetch-products-btn"
                                                class="btn btn-primary mt-2 w-100" onclick="fetchAcgiCustomerProducts()">Fetch</button>
                                            <div id="acgi-products-loading-spinner" class="text-center my-2"
                                                style="display:none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <div>Loading orders...</div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="mb-2" id="products-selector-container" style="display: none;">
                                                <label class="form-label">Select Order Item:</label>
                                                <select class="form-select" id="products-item-selector">
                                                    <option value="">Loading...</option>
                                                </select>
                                            </div>
                                            <label class="form-label">Fetched Data (JSON):</label>
                                            <pre id="acgi-products-json-viewer"
                                                style="background:#f8f9fa; border-radius:8px; padding:1em; min-height:120px; max-height:300px; overflow:auto; font-size:0.9em;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 2: Important Fields from First Product -->
                            <div class="col-md-3 mb-4">
                                <h4><i class="fas fa-star"></i> Important Fields</h4>
                                <div id="ordersACGIImportantFields" class="mb-4">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="ordersACGIAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No fields loaded
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 3: Mapping UI -->
                            <div class="col-md-3">
                                <h4><i class="fas fa-link"></i> Map to HubSpot Fields</h4>
                                <div id="ordersImportantFields" class="mb-4"> 
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="ordersAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see all available fields
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 4: HubSpot Form for Custom Object -->
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-save"></i> Save to HubSpot (ACGI Orders)
                                    </div>
                                    <div class="card-body">
                                        <div id="ordersForm">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-info-circle"></i> Load properties to see the form
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success w-100 mb-2"
                                                onclick="saveToHubSpot('orders')">
                                                <i class="fas fa-save"></i> Save to HubSpot
                                            </button>
                                            <button type="button" class="btn btn-warning w-100 mb-3"
                                                onclick="resetForm('orders')">
                                                <i class="fas fa-undo"></i> Reset Form
                                            </button>
                                        </div>
                                        <div id="ordersOutput" class="mt-3" style="display: none;">
                                            <h6><i class="fas fa-terminal"></i> Output:</h6>
                                            <div class="alert alert-info" id="ordersOutputContent">
                                                <!-- Output will be displayed here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Events Tab -->
                <div class="tab-pane fade" id="events" role="tabpanel">
                    <div class="mt-4">
                        <div class="row">
                            <div class="d-flex justify-content-center">
                                <button id="copyEventsToHubspotBtn" class="btn btn-outline-primary btn-sm mb-2"
                                    style="width: 10rem;">
                                    <i class="fas fa-arrow-right"></i> Copy To HubSpot
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <!-- COLUMN 1: Fetch Events -->
                            <div class="col-md-3 mb-4">
                                <div class="card mb-3">
                                    <div class="card-header bg-info text-white">
                                        <i class="fas fa-database"></i> ACGI Events Data
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="acgi-events-customer-id">ACGI Customer ID:</label>
                                            <input type="text" id="acgi-events-customer-id" class="form-control" />
                                            <button id="fetch-events-btn"
                                                class="btn btn-primary mt-2 w-100" onclick="fetchAcgiCustomerEvents()">Fetch</button>
                                            <div id="acgi-events-loading-spinner" class="text-center my-2"
                                                style="display:none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <div>Loading events...</div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="mb-2" id="events-selector-container" style="display: none;">
                                                <label class="form-label">Select Event Item:</label>
                                                <select class="form-select" id="events-item-selector">
                                                    <option value="">Loading...</option>
                                                </select>
                                            </div>
                                            <label class="form-label">Fetched Data (JSON):</label>
                                            <pre id="acgi-events-json-viewer"
                                                style="background:#f8f9fa; border-radius:8px; padding:1em; min-height:120px; max-height:300px; overflow:auto; font-size:0.9em;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 2: Important Fields from First Event -->
                            <div class="col-md-3 mb-4">
                                <h4><i class="fas fa-star"></i> Important Fields</h4>
                                <div id="eventsACGIImportantFields" class="mb-4">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="eventsACGIAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> No fields loaded
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 3: Mapping UI -->
                            <div class="col-md-3">
                                <h4><i class="fas fa-link"></i> Map to HubSpot Fields</h4>
                                <div id="eventsImportantFields" class="mb-4"> 
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see important fields
                                    </div>
                                </div>
                                <h4><i class="fas fa-list"></i> All Available Fields</h4>
                                <div id="eventsAllFields">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> Load properties to see all available fields
                                    </div>
                                </div>
                            </div>
                            <!-- COLUMN 4: HubSpot Form for Custom Object -->
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <i class="fas fa-save"></i> Save to HubSpot (ACGI Events)
                                    </div>
                                    <div class="card-body">
                                        <div id="eventsForm">
                                            <div class="text-center text-muted">
                                                <i class="fas fa-info-circle"></i> Load properties to see the form
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success w-100 mb-2"
                                                onclick="saveToHubSpot('events')">
                                                <i class="fas fa-save"></i> Save to HubSpot
                                            </button>
                                            <button type="button" class="btn btn-warning w-100 mb-3"
                                                onclick="resetForm('events')">
                                                <i class="fas fa-undo"></i> Reset Form
                                            </button>
                                        </div>
                                        <div id="eventsOutput" class="mt-3" style="display: none;">
                                            <h6><i class="fas fa-terminal"></i> Output:</h6>
                                            <div class="alert alert-info" id="eventsOutputContent">
                                                <!-- Output will be displayed here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div class="loading text-center mt-4" id="loadingSpinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading properties...</p>
            </div>

            <!-- Reload Buttons -->
            <div class="text-center mt-3" id="reloadButtonsContainer" style="display: none;">
                <button type="button" class="btn btn-outline-primary me-2" onclick="loadProperties()">
                    <i class="fas fa-sync-alt"></i> Reload All Properties
                </button>
                <button type="button" class="btn btn-outline-success me-2" onclick="loadContactsProperties()">
                    <i class="fas fa-user"></i> Reload Contacts Properties
                </button>
                <button type="button" class="btn btn-outline-info" onclick="loadDealsProperties()">
                    <i class="fas fa-handshake"></i> Reload Deals Properties
                </button>
                <button type="button" class="btn btn-warning" onclick="testMapping()">
                    <i class="fas fa-cog"></i> Test Mapping
                </button>
                <button type="button" class="btn btn-info" onclick="forceSaveMapping()">
                    <i class="fas fa-save"></i> Force Save Mapping
                </button>
                <button type="button" class="btn btn-secondary" onclick="refreshMappingsFromDatabase()">
                    <i class="fas fa-sync"></i> Refresh Mappings
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        let currentObjectType = 'contacts';
        let propertiesData = {};
        let currentAddressPreference = { mode: 'first' };
        
        // Mapping variables
        let contactsMapping = {};
        let membershipsMapping = {};
        let productsMapping = {};
        let eventsMapping = {};
        let acgiContactFields = {};
        let acgiMembershipFields = {};
        let acgiProductsFields = {};
        let acgiEventsFields = {};

        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('reloadButtonsContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('reloadButtonsContainer').style.display = 'block';
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) return;
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
            // Defensive: only insert if parent and reference node are both in the DOM
            if (alertContainer.parentNode && alertContainer.parentNode.contains(alertContainer)) {
                alertContainer.parentNode.insertBefore(alertDiv, alertContainer.nextSibling);
            } else {
                alertContainer.appendChild(alertDiv);
            }
            setTimeout(() => {
                alertDiv.classList.remove('show');
                alertDiv.classList.add('hide');
                setTimeout(() => alertDiv.remove(), 500);
            }, 4000);
        }

        function loadProperties() {
            showLoading();

            // Load properties for both object types
            Promise.all([
                loadObjectProperties('contacts'),
                //loadObjectProperties('deals'),
                loadObjectProperties('memberships'),
                loadObjectProperties('orders'),
                loadObjectProperties('events')
            ]).then(() => {
                hideLoading();
                showAlert('All properties loaded successfully!', 'success');
            }).catch(error => {
                console.log("error", error)
                hideLoading();
                console.error('Error loading properties:', error);
                showAlert('Error loading properties: ' + error.message + '\nPlease set your HubSpot API key on the Integration page first.', 'danger');
            });
        }

        function loadContactsProperties() {
            showLoading();
            loadObjectProperties('contacts')
                .then(() => {
                    hideLoading();
                    showAlert('Contacts properties loaded successfully!', 'success');
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error loading contacts properties:', error);
                    showAlert('Error loading contacts properties: ' + error.message + '\nPlease set your HubSpot API key on the Integration page first.', 'danger');
                });
        }

        function loadDealsProperties() {
            showLoading();
            loadObjectProperties('deals')
                .then(() => {
                    hideLoading();
                    showAlert('Deals properties loaded successfully!', 'success');
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error loading deals properties:', error);
                    showAlert('Error loading deals properties: ' + error.message + '\nPlease set your HubSpot API key on the Integration page first.', 'danger');
                });
        }

        function loadObjectProperties(objectType) {
            console.log(`Loading properties for ${objectType}...`);
            return fetch(`/api/hubspot-properties/${objectType}`)
                .then(response => {
                    console.log(`Response status for ${objectType}:`, response.status);
                    
                    return response.json();
                })
                .then(data => {
                    console.log(`Data received for ${objectType}:`, data);
                    if (data.error) {
                        throw new Error(data.error);
                    }

                    // Initialize arrays if they don't exist
                    if (!data.important_properties) data.important_properties = [];
                    if (!data.other_properties) data.other_properties = [];

                    propertiesData[objectType] = data;
                    console.log(`Rendering properties for ${objectType}...`);
                    renderProperties(objectType, data);
                    renderForm(objectType, data);
                })
                .catch(error => {
                    console.error(`Error loading properties for ${objectType}:`, error);
                    throw error;
                });
        }

        function renderProperties(objectType, data) {
            console.log("renderProperties called for", objectType, data);
            const importantContainer = document.getElementById(`${objectType}ImportantFields`);
            const allContainer = document.getElementById(`${objectType}AllFields`);
            
            console.log("Important container:", importantContainer);
            console.log("All container:", allContainer);

            // Initialize arrays if they don't exist
            if (!data.important_properties) data.important_properties = [];
            if (!data.other_properties) data.other_properties = [];

            // Sort other properties alphabetically by name (important properties keep their order)
            data.other_properties.sort((a, b) => {
                const nameA = a.name || '';
                const nameB = b.name || '';
                return nameA.localeCompare(nameB);
            });

            // Render important properties
            if (data.important_properties.length > 0) {
                importantContainer.innerHTML = data.important_properties.map(prop =>
                    createPropertyCard(prop, objectType, true)
                ).join('');

                // Initialize drag-and-drop for important fields
                initializeSortable(objectType);
            } else {
                importantContainer.innerHTML = '<div class="text-center text-muted">No important fields configured</div>';
            }

            // Render all properties
            if (data.other_properties.length > 0) {
                allContainer.innerHTML = data.other_properties.map(prop =>
                    createPropertyCard(prop, objectType, false)
                ).join('');
            } else {
                allContainer.innerHTML = '<div class="text-center text-muted">No additional fields available</div>';
            }
        }

        function initializeSortable(objectType) {
            const importantContainer = document.getElementById(`${objectType}ImportantFields`);

            // Remove existing sortable instance if it exists
            if (importantContainer.sortable) {
                importantContainer.sortable.destroy();
            }

            // Initialize new sortable instance
            importantContainer.sortable = Sortable.create(importantContainer, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function (evt) {
                    // Update order indices after drag ends
                    updateFieldOrder(objectType);
                    // Re-render the HubSpot form to reflect new order
                    renderForm(objectType, propertiesData[objectType]);
                }
            });
        }

        function updateFieldOrder(objectType) {
            console.log(`updateFieldOrder called for ${objectType}`);
            const data = propertiesData[objectType];
            if (!data || !data.important_properties) {
                console.log(`No data or important properties for ${objectType}`);
                return;
            }
            
            const importantContainer = document.getElementById(`${objectType}ImportantFields`);
            const cards = importantContainer.querySelectorAll('.property-card');
            console.log(`Found ${cards.length} cards to reorder`);
            
            // Update order indices based on new positions
            let newOrder = [];
            cards.forEach((card, index) => {
                const fieldName = card.getAttribute('data-field-name');
                const property = data.important_properties.find(p => p.name === fieldName);
                if (property) {
                    property.order_index = index;
                    newOrder.push(property);
                    console.log(`Saving field configuration for ${fieldName} with order ${index}`);
                    // Save the updated order to database
                    saveFieldConfiguration(objectType, property, 'order');
                }
            });
            
            // Replace important_properties with new order
            data.important_properties = newOrder;
            console.log(`New order for ${objectType}:`, newOrder.map(p => `${p.name} (${p.order_index})`));
            
            // Re-render the HubSpot form to reflect new order
            renderForm(objectType, data);
            console.log('Field order updated for', objectType);
            
            // Force save mapping after a short delay to ensure all field configurations are saved
            setTimeout(() => {
                console.log(`Forcing mapping save for ${objectType} after order change...`);
                saveMappingSilently(objectType);
            }, 500);
        }

        function createPropertyCard(property, objectType, isImportant) {
            const badges = [];
            if (isImportant) badges.push('<span class="badge badge-important">Important</span>');
            if (property.is_enabled) badges.push('<span class="badge badge-enabled">Enabled</span>');

            const dragHandle = isImportant ?
                '<div class="drag-handle me-2" style="cursor: grab; color: #6c757d;"><i class="fas fa-grip-vertical"></i></div>' : '';

            return `
                <div class="property-card ${isImportant ? 'important' : ''} ${property.is_enabled ? 'enabled' : ''}" data-field-name="${property.name}">
                    <div class="property-header">
                        <div class="d-flex align-items-center">
                            ${dragHandle}
                        <div>
                                <div class="property-name" title="${property.name}">${property.name}</div>
                            <div class="property-label">${property.label || property.name}</div>
                            </div>
                        </div>
                        <div class="property-actions">
                            ${badges.join('')}
                            <span class="property-type">${property.type}</span>
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="toggleField('${objectType}', '${property.name}', 'important')">
                                    <i class="fas fa-star"></i>
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="toggleField('${objectType}', '${property.name}', 'enabled')">
                                    <i class="fas fa-toggle-on"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderForm(objectType, data) {
            const formContainer = document.getElementById(`${objectType}Form`);

            if (!data) {
                formContainer.innerHTML = '<div class="text-center text-muted">No properties available</div>';
                return;
            }

            // Initialize arrays if they don't exist
            if (!data.important_properties) data.important_properties = [];
            if (!data.other_properties) data.other_properties = [];

            // Combine all properties for the form
            const allProperties = [
                ...data.important_properties,
                ...data.other_properties
            ];

            if (allProperties.length === 0) {
                formContainer.innerHTML = '<div class="text-center text-muted">No properties available</div>';
                return;
            }

            const formFields = allProperties
                .filter(prop => prop.is_enabled)
                .map(prop => createFormField(prop, objectType))
                .join('');

            formContainer.innerHTML = formFields;
        }

        function createFormField(property, objectType) {
            const fieldId = `${objectType}_${property.name}`;
            const label = property.label || property.name;

            let inputHtml = '';
            switch (property.type) {
                case 'number':
                    inputHtml = `<input type="number" class="form-control" id="${fieldId}" name="${property.name}">`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" class="form-control" id="${fieldId}" name="${property.name}" data-field-type="date">`;
                    break;
                case 'datetime':
                    inputHtml = `<input type="datetime-local" class="form-control" id="${fieldId}" name="${property.name}" data-field-type="datetime">`;
                    break;
                case 'textarea':
                    inputHtml = `<textarea class="form-control" id="${fieldId}" name="${property.name}" rows="3"></textarea>`;
                    break;
                case 'enumeration':
                case 'select':
                    // Handle enumeration fields with options
                    let options = '<option value="">Select an option...</option>';
                    if (property.options && Array.isArray(property.options)) {
                        options += property.options.map(opt =>
                            `<option value="${opt.value || opt}">${opt.label || opt}</option>`
                        ).join('');
                    } else if (property.options && typeof property.options === 'object') {
                        // Handle case where options might be in a different format
                        Object.entries(property.options).forEach(([value, label]) => {
                            options += `<option value="${value}">${label}</option>`;
                        });
                    }
                    inputHtml = `<select class="form-control" id="${fieldId}" name="${property.name}">${options}</select>`;
                    break;
                default:
                    inputHtml = `<input type="text" class="form-control" id="${fieldId}" name="${property.name}">`;
            }

            return `
                <div class="form-row">
                    <label for="${fieldId}">${label}</label>
                    ${inputHtml}
                </div>
            `;
        }

        function toggleField(objectType, fieldName, toggleType) {
            console.log(`toggleField called: ${objectType}, ${fieldName}, ${toggleType}`);
            
            const data = propertiesData[objectType];
            if (!data) {
                console.log('No data found for objectType:', objectType);
                return;
            }

            // Initialize arrays if they don't exist
            if (!data.important_properties) data.important_properties = [];
            if (!data.other_properties) data.other_properties = [];

            // Find the property in both sections
            let property = data.important_properties.find(p => p.name === fieldName);
            let isInImportant = true;

            if (!property) {
                property = data.other_properties.find(p => p.name === fieldName);
                isInImportant = false;
            }

            if (!property) {
                console.log('Property not found:', fieldName);
                return;
            }

            console.log(`Toggling field: ${fieldName}, type: ${toggleType}, currently in important: ${isInImportant}`);
            console.log('Before toggle - Important:', data.important_properties.length, 'Other:', data.other_properties.length);

            // Toggle the property
            if (toggleType === 'important') {
                // Toggle the important state
                property.is_important = !property.is_important;
                console.log(`Property ${fieldName} is_important changed to:`, property.is_important);

                // Remove from current array
                if (isInImportant) {
                    data.important_properties = data.important_properties.filter(p => p.name !== fieldName);
                } else {
                    data.other_properties = data.other_properties.filter(p => p.name !== fieldName);
                }

                // Add to correct array based on new state
                if (property.is_important) {
                    data.important_properties.push(property);
                } else {
                    data.other_properties.push(property);
                }
            } else if (toggleType === 'enabled') {
                property.is_enabled = !property.is_enabled;
                console.log(`Property ${fieldName} is_enabled changed to:`, property.is_enabled);
            }

            console.log('After toggle - Important:', data.important_properties.length, 'Other:', data.other_properties.length);
            console.log('Property is_important:', property.is_important);

            // Save to database
            console.log('Calling saveFieldConfiguration...');
            saveFieldConfiguration(objectType, property, toggleType);

            // Re-render
            renderProperties(objectType, data);
            renderForm(objectType, data);
        }

        function saveFieldConfiguration(objectType, property, toggleType) {
            console.log(`saveFieldConfiguration called: ${objectType}, ${property.name}, ${toggleType}`);
            
            let data = {
                object_type: objectType,
                field_name: property.name,
                order_index: property.order_index || 0
            };

            // Only send the relevant data based on toggle type
            if (toggleType === 'order') {
                console.log(`Order update - sending data:`, data);
                // Only send order_index for order updates
            } else {
                // Send all field data for other updates
                data.field_label = property.label || property.name;
                data.field_type = property.type;
                data.is_enabled = property.is_enabled;
                data.is_important = property.is_important;
                console.log(`Other update - sending data:`, data);
            }

            fetch('/api/save-form-field', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (!result.success) {
                        console.error('Failed to save field configuration:', result.error);
                    } else {
                        console.log(`Field configuration saved successfully for ${objectType}, now saving mapping...`);
                        // After successfully saving field configuration, also save the current mappings
                        saveMappingSilently(objectType);
                    }
                })
                .catch(error => {
                    console.error('Error saving field configuration:', error);
                });
        }

        function saveToHubSpot(objectType) {
            // Collect form data from all enabled fields
            const formData = {};
            const form = document.getElementById(`${objectType}Form`);
            const inputs = form.querySelectorAll('input, select, textarea');
            console.log("INPUTS",inputs)
            console.log("OBJECT TYPE",objectType)
            inputs.forEach(input => {
                if (input.value.trim()) {
                    console.log("INPUT value",input.value)
                    console.log("INPUT field type", input.getAttribute('data-field-type'))
                    console.log("INPUT type", input.type)
                    console.log("INPUT name", input.name)
                    let value = input.value;

                    // Convert datetime fields to milliseconds for HubSpot API
                    if (input.getAttribute('data-field-type') === 'datetime') {
                        console.log("Processing datetime field:", input.name, value);
                        const date = new Date(value);
                        if (!isNaN(date.getTime())) {
                            value = date.getTime().toString();
                            console.log("Converted datetime to:", value);
                        }
                    } else if (input.getAttribute('data-field-type') === 'date') {
                        console.log("Processing date field:", input.name, value);
                        // For date fields, ensure the timestamp is at midnight UTC
                        const dateParts = value.split('-');
                        if (dateParts.length === 3) {
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                            const day = parseInt(dateParts[2]);
                            // Create date at midnight UTC
                            const date = new Date(Date.UTC(year, month, day));
                        if (!isNaN(date.getTime())) {
                            value = date.getTime().toString();
                            console.log("Converted date to:", value);
                            }
                        } else {
                            // Fallback to regular date parsing
                            const date = new Date(value + 'T00:00:00Z');
                            if (!isNaN(date.getTime())) {
                                value = date.getTime().toString();
                                console.log("Fallback date conversion to:", value);
                            }
                        }
                    } else if (input.type === 'date') {
                        console.log("Processing HTML5 date field:", input.name, value);
                        // Handle HTML5 date inputs that might not have data-field-type
                        const dateParts = value.split('-');
                        if (dateParts.length === 3) {
                            const year = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                            const day = parseInt(dateParts[2]);
                            // Create date at midnight UTC
                            const date = new Date(Date.UTC(year, month, day));
                            if (!isNaN(date.getTime())) {
                                value = date.getTime().toString();
                                console.log("Converted HTML5 date to:", value);
                            }
                        }
                    }

                    formData[input.name] = value;
                }
            });

            console.log("FORM DATA",formData)
            if (Object.keys(formData).length === 0) {
                showOutput(objectType, 'Please fill in at least one field', 'warning');
                return;
            }

            showLoading();

            const requestData = {
                object_data: formData
            };

            fetch(`/api/save-to-hubspot/${objectType}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => response.json())
                .then(result => {
                    console.log("SAVE TO HUBSPOT RESULT",result)
                    hideLoading();
                    if (result.success) {
                        let message = `<strong>${result.message}</strong><br><br>`;
                        message += `<strong>Details:</strong><br>${result.details}<br><br>`;

                        if (result.search_strategy) {
                            message += `<strong>Search Strategy Used:</strong> ${result.search_strategy}<br>`;
                        }
                        if (result.search_info) {
                            message += `<strong>Search Details:</strong> ${result.search_info}<br>`;
                        }
                        if (result.acgi_customer_id) {
                            message += `<strong>ACGI Customer ID:</strong> ${result.acgi_customer_id}<br>`;
                        }
                        if (result.contact_id) {
                            message += `<strong>HubSpot Contact ID:</strong> ${result.contact_id}<br>`;
                        }
                        if (result.deal_id) {
                            message += `<strong>HubSpot Deal ID:</strong> ${result.deal_id}<br>`;
                        }

                        message += `<br><strong>Data sent to HubSpot:</strong><br><pre>${JSON.stringify(formData, null, 2)}</pre>`;

                        if (result.hubspot_response) {
                            message += `<br><strong>HubSpot Response:</strong><br><pre>${JSON.stringify(result.hubspot_response, null, 2)}</pre>`;
                        }

                        showOutput(objectType, message, 'success');
                        resetForm(objectType, false); // Don't clear output after successful save
                    } else {
                        let message = `<strong>${result.message}</strong><br><br>`;
                        if (result.details) {
                            message += `<strong>Details:</strong><br>${result.details}<br><br>`;
                        }
                        message += `<strong>Data sent:</strong><br><pre>${JSON.stringify(formData, null, 2)}</pre>`;

                        showOutput(objectType, message, 'danger');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error saving to HubSpot:', error);
                    showOutput(objectType, `❌ Error saving to HubSpot: ${error.message}<br><br><strong>Data sent:</strong><br><pre>${JSON.stringify(formData, null, 2)}</pre>`, 'danger');
                });
        }

        function showOutput(objectType, message, type = 'info') {
            const outputContainer = document.getElementById(`${objectType}Output`);
            const outputContent = document.getElementById(`${objectType}OutputContent`);

            outputContent.className = `alert alert-${type}`;
            outputContent.innerHTML = message;
            outputContainer.style.display = 'block';

            // Scroll to output
            outputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function resetForm(objectType, clearOutput = true) {
            const form = document.getElementById(`${objectType}Form`);
            const inputs = form.querySelectorAll('input, select, textarea');

            inputs.forEach(input => {
                input.value = '';
            });

            // Clear output area only if requested
            if (clearOutput) {
                const outputContainer = document.getElementById(`${objectType}Output`);
                outputContainer.style.display = 'none';
            }
        }

        // Handle tab changes and load properties on page load
        document.addEventListener('DOMContentLoaded', function () {
            // Load properties automatically when page loads
            loadProperties();

            // Load search preferences
            loadSearchPreferences();

            // Handle URL parameters for tab state
            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('tab') || 'contacts';
            
            // Activate the appropriate tab based on URL parameter
            if (activeTab === 'memberships') {
                const membershipsTab = document.getElementById('memberships-tab');
                const membershipsPane = document.getElementById('memberships');
                const contactsTab = document.getElementById('contacts-tab');
                const contactsPane = document.getElementById('contacts');
                
                // Remove active class from contacts
                contactsTab.classList.remove('active');
                contactsPane.classList.remove('show', 'active');
                
                // Add active class to memberships
                membershipsTab.classList.add('active');
                membershipsPane.classList.add('show', 'active');
                
                currentObjectType = 'memberships';
            } else if (activeTab === 'purchased-products') {
                const productsTab = document.getElementById('purchased-products-tab');
                const productsPane = document.getElementById('purchased-products');
                const contactsTab = document.getElementById('contacts-tab');
                const contactsPane = document.getElementById('contacts');
                
                // Remove active class from contacts
                contactsTab.classList.remove('active');
                contactsPane.classList.remove('show', 'active');
                
                // Add active class to products
                productsTab.classList.add('active');
                productsPane.classList.add('show', 'active');
                
                currentObjectType = 'orders';
            } else if (activeTab === 'events') {
                const eventsTab = document.getElementById('events-tab');
                const eventsPane = document.getElementById('events');
                const contactsTab = document.getElementById('contacts-tab');
                const contactsPane = document.getElementById('contacts');
                
                // Remove active class from contacts
                contactsTab.classList.remove('active');
                contactsPane.classList.remove('show', 'active');
                
                // Add active class to events
                eventsTab.classList.add('active');
                eventsPane.classList.add('show', 'active');
                
                currentObjectType = 'events';
            } else {
                // Default to contacts tab
                currentObjectType = 'contacts';
            }

            const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
            tabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const target = event.target.getAttribute('data-bs-target');
                    let newTab = 'contacts';
                    
                    if (target === '#contacts') {
                        currentObjectType = 'contacts';
                        newTab = 'contacts';
                    } else if (target === '#memberships') {
                        currentObjectType = 'memberships';
                        newTab = 'memberships';
                    } else if (target === '#purchased-products') {
                        currentObjectType = 'orders';
                        newTab = 'purchased-products';
                    } else if (target === '#events') {
                        currentObjectType = 'events';
                        newTab = 'events';
                    }
                    
                    // Update URL with the new tab parameter
                    const url = new URL(window.location);
                    url.searchParams.set('tab', newTab);
                    window.history.replaceState({}, '', url);
                });
            });
            
            // Update navigation links to preserve current tab
            updateNavigationLinks();
        });
        
        function updateNavigationLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const currentTab = urlParams.get('tab') || 'contacts';
            
            // Update the memberships link to include the current tab
            const membershipsLink = document.querySelector('a[href="/memberships"]');
            if (membershipsLink) {
                membershipsLink.href = `/memberships`;
            }
            
            // Update the ACGI to HubSpot link to preserve the current tab
            const acgiToHubspotLink = document.querySelector('a[href="/acgi-to-hubspot"]');
            if (acgiToHubspotLink) {
                acgiToHubspotLink.href = `/acgi-to-hubspot?tab=${currentTab}`;
            }
        }

        function saveSearchPreference(objectType) {
            const selectedRadio = document.querySelector(`input[name="${objectType}SearchPreference"]:checked`);
            if (!selectedRadio) {
                showAlert('Please select a search preference', 'warning');
                return;
            }

            const searchStrategy = selectedRadio.value;

            fetch('/api/save-search-preference', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    object_type: objectType,
                    search_strategy: searchStrategy
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showAlert(`Search preference saved for ${objectType}!`, 'success');
                    } else {
                        showAlert(`Failed to save search preference: ${result.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error saving search preference:', error);
                    showAlert(`Error saving search preference: ${error.message}`, 'danger');
                });
        }

        function loadSearchPreferences() {
            // Load preferences for both object types
            Promise.all([
                loadObjectSearchPreference('contacts'),
                loadObjectSearchPreference('deals')
            ]).catch(error => {
                console.error('Error loading search preferences:', error);
            });
        }

        function loadObjectSearchPreference(objectType) {
            return fetch(`/api/get-search-preference/${objectType}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const radioId = `${objectType}${data.search_strategy.charAt(0).toUpperCase() + data.search_strategy.slice(1).replace(/_([a-z])/g, (g) => g[1].toUpperCase())}`;
                        const radio = document.getElementById(radioId);
                        if (radio) {
                            radio.checked = true;
                        }
                    }
                });
        }

        // --- ACGI Fields UI logic ---
        let acgiFields = {};
        let acgiFieldConfig = {};
        let currentEmailPreference = { mode: 'first', format: 'json' };
        let currentPhonePreference = { mode: 'first', format: 'json' };
        let acgiMemberships = {};
        let acgiMembershipsFieldConfig = {};
        let acgiMembershipsList = []; // Store the full list of memberships
        let currentMembershipIndex = 0; // Track which membership is currently selected
        let acgiProducts = {};
        let acgiProductsFieldConfig = {};
        let acgiProductsList = []; // Store the full list of products
        let currentProductsIndex = 0; // Track which product is currently selected
        let acgiEvents = {};
        let acgiEventsFieldConfig = {};
        let acgiEventsList = []; // Store the full list of events
        let currentEventsIndex = 0; // Track which event is currently selected

        function showAcgiJson(data) {
            const jsonViewer = document.getElementById('acgi-json-viewer');
            jsonViewer.textContent = JSON.stringify(data, null, 2);
        }
        
        function showAcgiMembershipsJson(data) {
            const jsonViewer = document.getElementById('acgi-memberships-json-viewer');
            jsonViewer.textContent = JSON.stringify(data, null, 2);
        }

        function showAcgiOrdersJson(data) {
            const jsonViewer = document.getElementById('acgi-products-json-viewer');
            jsonViewer.textContent = JSON.stringify(data, null, 2);
        }

        function showAcgiEventsJson(data) {
            const jsonViewer = document.getElementById('acgi-events-json-viewer');
            jsonViewer.textContent = JSON.stringify(data, null, 2);
        }

        function populateMembershipSelector(membershipsList) {
            const container = document.getElementById('membership-selector-container');
            const selector = document.getElementById('membership-item-selector');
            
            if (!membershipsList || membershipsList.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Clear existing options
            selector.innerHTML = '';
            
            // Add options for each membership (1-based indexing for user display)
            membershipsList.forEach((membership, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Item ${index + 1}`;
                selector.appendChild(option);
            });
            
            // Show the selector and set default to first item
            container.style.display = 'block';
            selector.value = '0';
            currentMembershipIndex = 0;
        }

        function populateProductsSelector(productsList) {
            const container = document.getElementById('products-selector-container');
            const selector = document.getElementById('products-item-selector');
            
            if (!productsList || productsList.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Clear existing options
            selector.innerHTML = '';
            
            // Add options for each product (1-based indexing for user display)
            productsList.forEach((product, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Item ${index + 1}`;
                selector.appendChild(option);
            });
            
            // Show the selector and set default to first item
            container.style.display = 'block';
            selector.value = '0';
            currentProductsIndex = 0;
        }

        function populateEventsSelector(eventsList) {
            const container = document.getElementById('events-selector-container');
            const selector = document.getElementById('events-item-selector');
            
            if (!eventsList || eventsList.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            // Clear existing options
            selector.innerHTML = '';
            
            // Add options for each event (1-based indexing for user display)
            eventsList.forEach((event, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Event ${index + 1}`;
                selector.appendChild(option);
            });
            
            // Show the selector and set default to first item
            container.style.display = 'block';
            selector.value = '0';
            currentEventsIndex = 0;
        }

        function updateEventsDisplay() {
            if (acgiEventsList.length === 0) return;
            
            // Update the current event data
            acgiEvents = ensureAcgiFieldsObject(acgiEventsList[currentEventsIndex]);
            
            // Update JSON viewer
            showAcgiEventsJson(acgiEventsList);
            
            // Re-render the fields with the new event data
            renderAcgiEventsFields(acgiEvents, acgiEventsFieldConfig);
        }

        function updateProductsDisplay() {
            if (acgiProductsList.length === 0) return;
            
            // Update the current product data
            acgiProducts = ensureAcgiFieldsObject(acgiProductsList[currentProductsIndex]);
            
            // Update JSON viewer
            showAcgiOrdersJson(acgiProductsList);
            
            // Re-render the fields with the new product data
            renderAcgiProductsFields(acgiProducts, acgiProductsFieldConfig);
        }

        function updateMembershipDisplay() {
            if (acgiMembershipsList.length === 0) return;
            
            // Update the current membership data
            acgiMemberships = ensureAcgiFieldsObject(acgiMembershipsList[currentMembershipIndex]);
            
            // Update JSON viewer
            showAcgiMembershipsJson(acgiMembershipsList);
            
            // Re-render the fields with the new membership data
            renderAcgiMembershipsFields(acgiMemberships, acgiMembershipsFieldConfig);
        }

        function formatAddressFlat(addr) {
            if (!addr) return '';
            let parts = [];
            if (addr.street1) parts.push(addr.street1);
            if (addr.street2) parts.push(addr.street2);
            if (addr.street3) parts.push(addr.street3);
            let cityStateZip = [];
            if (addr.city) cityStateZip.push(addr.city);
            if (addr.state) cityStateZip.push(addr.state);
            if (addr.postalCode) cityStateZip.push(addr.postalCode);
            if (cityStateZip.length) parts.push(cityStateZip.join(', '));
            if (addr.countryCode) parts.push(addr.countryCode);
            return parts.filter(Boolean).join(', ');
        }

        function selectAddressByPreference(addresses, preference) {
            if (!Array.isArray(addresses) || addresses.length === 0) return null;
            if (!preference || !preference.mode || preference.mode === 'first') {
                return addresses[0];
            }
            if (preference.mode === 'last') {
                return addresses[addresses.length - 1];
            }
            if (preference.mode === 'criteria' && preference.property && preference.operator) {
                return addresses.find(addr => {
                    const val = addr[preference.property];
                    const cmp = preference.value;
                    switch (preference.operator) {
                        case '=':
                            if (typeof val === 'boolean') return val === (cmp === 'true');
                            if (typeof val === 'number') return val === Number(cmp);
                            return val == cmp;
                        case '!=':
                            if (typeof val === 'boolean') return val !== (cmp === 'true');
                            if (typeof val === 'number') return val !== Number(cmp);
                            return val != cmp;
                        case 'contains': return val && typeof val === 'string' && val.includes(cmp);
                        case '>': return val > cmp;
                        case '<': return val < cmp;
                        case 'is null': return val === null || val === undefined;
                        case 'is not null': return val !== null && val !== undefined;
                        default: return false;
                    }
                }) || null;
            }
            return addresses[0];
        }

        function updateCurrentAddressPreference(cb) {
            fetch('/api/acgi-address-preference?object_type=contacts')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.preference) {
                        currentAddressPreference = data.preference;
                    } else {
                        currentAddressPreference = { mode: 'first' };
                    }
                    if (cb) cb();
                });
        }

        function updateCurrentEmailPreference(cb) {
            fetch('/api/acgi-email-preference?object_type=contacts')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.preference) {
                        currentEmailPreference = data.preference;
                    } else {
                        currentEmailPreference = { mode: 'first', format: 'json' };
                    }
                    if (cb) cb();
                });
        }

        function updateCurrentPhonePreference(cb) {
            fetch('/api/acgi-phone-preference?object_type=contacts')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.preference) {
                        currentPhonePreference = data.preference;
                    } else {
                        currentPhonePreference = { mode: 'first', format: 'json' };
                    }
                    if (cb) cb();
                });
        }

        function renderAcgiFields(fields, config) {
            if (!config) {
                console.warn('renderAcgiFields: config is not a valid object', config);
                document.getElementById('acgiImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('acgiAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            if (!fields || typeof fields !== 'object' || Array.isArray(fields)) {
                console.warn('renderAcgiFields: fields is not a valid object', fields);
                document.getElementById('acgiImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('acgiAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            console.log('Rendering ACGI fields:', fields, config);
            const importantDiv = document.getElementById('acgiImportantFields');
            const allDiv = document.getElementById('acgiAllFields');
            importantDiv.innerHTML = '';
            allDiv.innerHTML = '';
            let importantFields = [];
            let allFields = [];
            Object.entries(fields).forEach(([key, value]) => {
                const fieldConfig = config[key] || {};
                const isImportant = !!fieldConfig.is_important;
                const isEnabled = fieldConfig.is_enabled !== false; // default true
                let displayValue = value;
                if (key === 'addresses' && Array.isArray(value)) {
                    const selected = selectAddressByPreference(value, currentAddressPreference);
                    if ((currentAddressPreference && currentAddressPreference.format === 'flat')) {
                        displayValue = selected ? formatAddressFlat(selected) : '';
                    } else {
                        displayValue = selected ? JSON.stringify(selected, null, 2) : '';
                    }
                } else if (key === 'emails' && Array.isArray(value)) {
                    const selected = selectItemByPreference(value, currentEmailPreference);
                    if (currentEmailPreference && currentEmailPreference.format === 'flat') {
                        displayValue = selected ? formatEmailFlat(selected) : '';
                    } else {
                        displayValue = selected ? JSON.stringify(selected, null, 2) : '';
                    }
                } else if (key === 'phones' && Array.isArray(value)) {
                    const selected = selectItemByPreference(value, currentPhonePreference);
                    if (currentPhonePreference && currentPhonePreference.format === 'flat') {
                        displayValue = selected ? formatPhoneFlat(selected) : '';
                    } else {
                        displayValue = selected ? JSON.stringify(selected, null, 2) : '';
                    }
                } else if (typeof value === 'object') {
                    displayValue = JSON.stringify(value);
                }
                const card = document.createElement('div');
                card.className = 'property-card' + (isImportant ? ' important' : '') + (isEnabled ? ' enabled' : '');
                card.setAttribute('data-field-name', key);
                card.innerHTML = `
                    <div class="property-header d-flex justify-content-between align-items-center">
                        ${isImportant ? '<div class="drag-handle me-2" style="cursor: grab; color: #6c757d;"><i class="fas fa-grip-vertical"></i></div>' : ''}
                        <span class="property-name" title="${key}">${key}</span>
                        <div class="property-actions">
                            <span class="badge badge-important" style="background:#28a745;${isImportant ? '' : 'display:none'}">Important</span>
                            <span class="badge badge-enabled" style="background:#667eea;${isEnabled ? '' : 'display:none'}">Enabled</span>
                            <button class="btn btn-outline-success btn-sm" onclick="toggleAcgiField('${key}','important')"><i class="fas fa-star"></i></button>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleAcgiField('${key}','enabled')"><i class="fas fa-toggle-on"></i></button>
                        </div>
                    </div>
                    <div class="property-label">${displayValue}</div>
                `;
                if (isImportant) {
                    importantFields.push({ card, order: fieldConfig.order_index || 0, key });
                } else {
                    allFields.push(card);
                }
            });
            // Sort important fields by order_index
            importantFields.sort((a, b) => a.order - b.order);
            importantFields.forEach(f => importantDiv.appendChild(f.card));
            allFields.forEach(card => allDiv.appendChild(card));
            if (importantFields.length === 0) importantDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No important fields</div>`;
            if (allFields.length === 0) allDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No fields loaded</div>`;
            // Enable drag-and-drop for important fields
            if (importantFields.length > 1 && window.Sortable) {
                if (importantDiv.sortable) importantDiv.sortable.destroy();
                importantDiv.sortable = Sortable.create(importantDiv, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        // Update order indices in acgiFieldConfig
                        const cards = importantDiv.querySelectorAll('.property-card');
                        cards.forEach((card, idx) => {
                            const fieldName = card.getAttribute('data-field-name');
                            if (!acgiFieldConfig[fieldName]) acgiFieldConfig[fieldName] = { is_important: true, is_enabled: true };
                            acgiFieldConfig[fieldName].order_index = idx;
                        });
                        // Save config
                        console.log("acgiFieldConfig CONTACTS",acgiFieldConfig)
                        saveAcgiFieldConfig('contacts', acgiFieldConfig);
                        // Save mapping after order change
                        if (propertiesData['contacts']) {
                            saveMappingSilently('contacts');
                        }
                    }
                });
            }
        }

        function renderAcgiMembershipsFields(fields, config) {
            if (!config) {
                console.warn('renderAcgiMembershipsFields: config is not a valid object', config);
                document.getElementById('membershipACGIImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('membershipACGIAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            if (!fields || typeof fields !== 'object' || Array.isArray(fields)) {
                console.warn('renderAcgiMembershipsFields: fields is not a valid object', fields);
                document.getElementById('membershipACGIImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('membershipACGIAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            console.log('Rendering ACGI memberships fields:', fields, config);
            const importantDiv = document.getElementById('membershipACGIImportantFields');
            const allDiv = document.getElementById('membershipACGIAllFields');
            importantDiv.innerHTML = '';
            allDiv.innerHTML = '';
            let importantFields = [];
            let allFields = [];
            Object.entries(fields).forEach(([key, value]) => {
                const fieldConfig = config[key] || {};
                const isImportant = !!fieldConfig.is_important;
                const isEnabled = fieldConfig.is_enabled !== false; // default true
                let displayValue = value;
                const card = document.createElement('div');
                card.className = 'property-card' + (isImportant ? ' important' : '') + (isEnabled ? ' enabled' : '');
                card.setAttribute('data-field-name', key);
                card.innerHTML = `
                    <div class="property-header d-flex justify-content-between align-items-center">
                        ${isImportant ? '<div class="drag-handle me-2" style="cursor: grab; color: #6c757d;"><i class="fas fa-grip-vertical"></i></div>' : ''}      
                        <span class="property-name" title="${key}">${key}</span>
                        <div class="property-actions">
                            <span class="badge badge-important" style="background:#28a745;${isImportant ? '' : 'display:none'}">Important</span>
                            <span class="badge badge-enabled" style="background:#667eea;${isEnabled ? '' : 'display:none'}">Enabled</span>
                            <button class="btn btn-outline-success btn-sm" onclick="toggleAcgiMembershipsField('${key}','important')"><i class="fas fa-star"></i></button>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleAcgiMembershipsField('${key}','enabled')"><i class="fas fa-toggle-on"></i></button>
                        </div>
                    </div>
                    <div class="property-label">${displayValue}</div>
                `;
                if (isImportant) {
                    importantFields.push({ card, order: fieldConfig.order_index || 0, key });
                } else {
                    allFields.push(card);
                }
            });
            // Sort important fields by order_index
            importantFields.sort((a, b) => a.order - b.order);
            importantFields.forEach(f => importantDiv.appendChild(f.card));
            allFields.forEach(card => allDiv.appendChild(card));
            if (importantFields.length === 0) importantDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No important fields</div>`;
            if (allFields.length === 0) allDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No fields loaded</div>`;
            // Enable drag-and-drop for important fields
            if (importantFields.length > 1 && window.Sortable) {
                if (importantDiv.sortable) importantDiv.sortable.destroy();
                importantDiv.sortable = Sortable.create(importantDiv, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        // Update order indices in acgiFieldConfig
                        const cards = importantDiv.querySelectorAll('.property-card');
                        cards.forEach((card, idx) => {
                            const fieldName = card.getAttribute('data-field-name');
                            if (!acgiMembershipsFieldConfig[fieldName]) acgiMembershipsFieldConfig[fieldName] = { is_important: false, is_enabled: false };
                            acgiMembershipsFieldConfig[fieldName].order_index = idx;
                        });
                        // Save config
                        console.log("acgiMembershipsFieldConfig MEMBERSHIPS",acgiMembershipsFieldConfig)
                        saveAcgiFieldConfig('memberships', acgiMembershipsFieldConfig);
                        // Save mapping after order change
                        if (propertiesData['memberships']) {
                            saveMappingSilently('memberships');
                        }
                    }
                }); 
            }
            // // Add event listeners for field toggles
            // importantDiv.querySelectorAll('.toggle-field').forEach(btn => {
            //     btn.addEventListener('click', function() {
            //         toggleAcgiField(this.dataset.field, 'important');
            //     });
            // });
            // // Add event listeners for field toggles
            // allDiv.querySelectorAll('.toggle-field').forEach(btn => {
            //     btn.addEventListener('click', function() {
            //         toggleAcgiField(this.dataset.field, 'enabled');
            //     });
            // });
        }
        
        function renderAcgiOrdersFields(fields, config) {
            if (!config) {
                console.warn('renderAcgiOrdersFields: config is not a valid object', config);
                document.getElementById('ordersACGIImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('ordersACGIAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            if (!fields || typeof fields !== 'object' || Array.isArray(fields)) {
                console.warn('renderAcgiOrdersFields: fields is not a valid object', fields);
                document.getElementById('ordersACGIImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('ordersACGIAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            console.log('Rendering ACGI orders fields:', fields, config);
            const importantDiv = document.getElementById('ordersACGIImportantFields');
            const allDiv = document.getElementById('ordersACGIAllFields');
            importantDiv.innerHTML = '';
            allDiv.innerHTML = '';
            let importantFields = [];
            let allFields = [];
            Object.entries(fields).forEach(([key, value]) => {
                const fieldConfig = config[key] || {};
                const isImportant = !!fieldConfig.is_important;
                const isEnabled = fieldConfig.is_enabled !== false; // default true
                let displayValue = value;
                const card = document.createElement('div');
                card.className = 'property-card' + (isImportant ? ' important' : '') + (isEnabled ? ' enabled' : '');
                card.setAttribute('data-field-name', key);
                card.innerHTML = `
                    <div class="property-header d-flex justify-content-between align-items-center">
                        ${isImportant ? '<div class="drag-handle me-2" style="cursor: grab; color: #6c757d;"><i class="fas fa-grip-vertical"></i></div>' : ''}          
                        <span class="property-name" title="${key}">${key}</span>
                        <div class="property-actions">
                            <span class="badge badge-important" style="background:#28a745;${isImportant ? '' : 'display:none'}">Important</span>
                            <span class="badge badge-enabled" style="background:#667eea;${isEnabled ? '' : 'display:none'}">Enabled</span>
                            <button class="btn btn-outline-success btn-sm" onclick="toggleAcgiOrdersField('${key}','important')"><i class="fas fa-star"></i></button>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleAcgiOrdersField('${key}','enabled')"><i class="fas fa-toggle-on"></i></button>
                        </div>
                    </div>
                    <div class="property-label">${displayValue}</div>
                `;
                if (isImportant) {
                    importantFields.push({ card, order: fieldConfig.order_index || 0, key });
                } else {
                    allFields.push(card);
                }
            });
            // Sort important fields by order_index
            importantFields.sort((a, b) => a.order - b.order);
            importantFields.forEach(f => importantDiv.appendChild(f.card));
            allFields.forEach(card => allDiv.appendChild(card));
            if (importantFields.length === 0) importantDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No important fields</div>`;
            if (allFields.length === 0) allDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No fields loaded</div>`;
            // Enable drag-and-drop for important fields
            if (importantFields.length > 1 && window.Sortable) {
                if (importantDiv.sortable) importantDiv.sortable.destroy();
                importantDiv.sortable = Sortable.create(importantDiv, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        // Update order indices in acgiFieldConfig
                        const cards = importantDiv.querySelectorAll('.property-card');
                        cards.forEach((card, idx) => {
                            const fieldName = card.getAttribute('data-field-name');
                            if (!acgiFieldConfig[fieldName]) acgiFieldConfig[fieldName] = { is_important: true, is_enabled: true };
                            acgiFieldConfig[fieldName].order_index = idx;
                        });
                        // Save config
                        console.log("acgiFieldConfig ORDERS",acgiFieldConfig)
                        saveAcgiFieldConfig('orders', acgiFieldConfig);
                        // Save mapping after order change
                        if (propertiesData['orders']) {
                            saveMappingSilently('orders');
                        }
                    }
                });
            }
        }

        function renderAcgiEventsFields(fields, config) {
            if (!config) {
                console.warn('renderAcgiEventsFields: config is not a valid object', config);
                document.getElementById('eventsACGIImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('eventsACGIAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            if (!fields || typeof fields !== 'object' || Array.isArray(fields)) {
                console.warn('renderAcgiEventsFields: fields is not a valid object', fields);
                document.getElementById('eventsACGIImportantFields').innerHTML = '<div class="text-center text-muted">No important fields</div>';
                document.getElementById('eventsACGIAllFields').innerHTML = '<div class="text-center text-muted">No fields loaded</div>';
                return;
            }
            console.log('Rendering ACGI events fields:', fields, config);
            const importantDiv = document.getElementById('eventsACGIImportantFields');
            const allDiv = document.getElementById('eventsACGIAllFields');
            importantDiv.innerHTML = '';
            allDiv.innerHTML = '';
            let importantFields = [];
            let allFields = [];
            Object.entries(fields).forEach(([key, value]) => {
                const fieldConfig = config[key] || {};
                const isImportant = !!fieldConfig.is_important;
                const isEnabled = fieldConfig.is_enabled !== false; // default true
                let displayValue = value;
                const card = document.createElement('div');
                card.className = 'property-card' + (isImportant ? ' important' : '') + (isEnabled ? ' enabled' : '');
                card.setAttribute('data-field-name', key);
                card.innerHTML = `
                    <div class="property-header d-flex justify-content-between align-items-center">
                        ${isImportant ? '<div class="drag-handle me-2" style="cursor: grab; color: #6c757d;"><i class="fas fa-grip-vertical"></i></div>' : ''}          
                        <span class="property-name" title="${key}">${key}</span>
                        <div class="property-actions">
                            <span class="badge badge-important" style="background:#28a745;${isImportant ? '' : 'display:none'}">Important</span>
                            <span class="badge badge-enabled" style="background:#667eea;${isEnabled ? '' : 'display:none'}">Enabled</span>
                            <button class="btn btn-outline-success btn-sm" onclick="toggleAcgiEventsField('${key}','important')"><i class="fas fa-star"></i></button>
                            <button class="btn btn-outline-primary btn-sm" onclick="toggleAcgiEventsField('${key}','enabled')"><i class="fas fa-toggle-on"></i></button>
                        </div>
                    </div>
                    <div class="property-label">${displayValue}</div>
                `;
                if (isImportant) {
                    importantFields.push({ card, order: fieldConfig.order_index || 0, key });
                } else {
                    allFields.push(card);
                }
            });
            // Sort important fields by order_index
            importantFields.sort((a, b) => a.order - b.order);
            importantFields.forEach(f => importantDiv.appendChild(f.card));
            allFields.forEach(card => allDiv.appendChild(card));
            if (importantFields.length === 0) importantDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No important fields</div>`;
            if (allFields.length === 0) allDiv.innerHTML = `<div class="text-center text-muted"><i class="fas fa-info-circle"></i> No fields loaded</div>`;
            // Enable drag-and-drop for important fields
            if (importantFields.length > 1 && window.Sortable) {
                if (importantDiv.sortable) importantDiv.sortable.destroy();
                importantDiv.sortable = Sortable.create(importantDiv, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    onEnd: function (evt) {
                        // Update order indices in acgiFieldConfig
                        const cards = importantDiv.querySelectorAll('.property-card');
                        cards.forEach((card, idx) => {
                            const fieldName = card.getAttribute('data-field-name');
                            if (!acgiFieldConfig[fieldName]) acgiFieldConfig[fieldName] = { is_important: true, is_enabled: true };
                            acgiFieldConfig[fieldName].order_index = idx;
                        });
                        // Save config
                        console.log("acgiFieldConfig EVENTS",acgiFieldConfig)
                        saveAcgiFieldConfig('events', acgiFieldConfig);
                        // Save mapping after order change
                        if (propertiesData['events']) {
                            saveMappingSilently('events');
                        }
                    }
                });
            }
        }

        function toggleAcgiField(field, type) {
            if (!acgiFieldConfig[field]) acgiFieldConfig[field] = { is_important: false, is_enabled: true };
            if (type === 'important') acgiFieldConfig[field].is_important = !acgiFieldConfig[field].is_important;
            if (type === 'enabled') acgiFieldConfig[field].is_enabled = !acgiFieldConfig[field].is_enabled;
            renderAcgiFields(acgiFields, acgiFieldConfig);
            saveAcgiFieldConfig('contacts', acgiFieldConfig);
            // Save mapping after ACGI field configuration changes
            if (propertiesData['contacts']) {
                saveMappingSilently('contacts');
            }
        }
        function toggleAcgiMembershipsField(field, type) {
            if (!acgiMembershipsFieldConfig[field]) acgiMembershipsFieldConfig[field] = { is_important: false, is_enabled: true };
            if (type === 'important') acgiMembershipsFieldConfig[field].is_important = !acgiMembershipsFieldConfig[field].is_important;
            if (type === 'enabled') acgiMembershipsFieldConfig[field].is_enabled = !acgiMembershipsFieldConfig[field].is_enabled;
            // if not important, remove the order_index
            if (!acgiMembershipsFieldConfig[field].is_important) {
                delete acgiMembershipsFieldConfig[field].order_index;
            }
            renderAcgiMembershipsFields(acgiMemberships, acgiMembershipsFieldConfig);
            saveAcgiFieldConfig('memberships', acgiMembershipsFieldConfig);
            // Save mapping after ACGI field configuration changes
            if (propertiesData['memberships']) {
                saveMappingSilently('memberships');
            }
        }

        function toggleAcgiOrdersField(field, type) {
            if (!acgiOrdersFieldConfig[field]) acgiOrdersFieldConfig[field] = { is_important: false, is_enabled: true };
            if (type === 'important') acgiOrdersFieldConfig[field].is_important = !acgiOrdersFieldConfig[field].is_important;
            if (type === 'enabled') acgiOrdersFieldConfig[field].is_enabled = !acgiOrdersFieldConfig[field].is_enabled;
            // if not important, remove the order_index
            if (!acgiOrdersFieldConfig[field].is_important) {
                delete acgiOrdersFieldConfig[field].order_index;
            }
            renderAcgiOrdersFields(acgiOrders, acgiOrdersFieldConfig);
            saveAcgiFieldConfig('orders', acgiOrdersFieldConfig);
            // Save mapping after ACGI field configuration changes
            if (propertiesData['orders']) {
                saveMappingSilently('orders');
            }
        }

        function toggleAcgiEventsField(field, type) {
            if (!acgiEventsFieldConfig[field]) acgiEventsFieldConfig[field] = { is_important: false, is_enabled: true };
            if (type === 'important') acgiEventsFieldConfig[field].is_important = !acgiEventsFieldConfig[field].is_important;
            if (type === 'enabled') acgiEventsFieldConfig[field].is_enabled = !acgiEventsFieldConfig[field].is_enabled;
            // if not important, remove the order_index
            if (!acgiEventsFieldConfig[field].is_important) {
                delete acgiEventsFieldConfig[field].order_index;
            }
            renderAcgiEventsFields(acgiEvents, acgiEventsFieldConfig);
            saveAcgiFieldConfig('events', acgiEventsFieldConfig);
            // Save mapping after ACGI field configuration changes
            if (propertiesData['events']) {
                saveMappingSilently('events');
            }
        }

        function saveAcgiFieldConfig(object_type, config) {
            fetch('/api/acgi-field-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ object_type, config })
            }).then(res => res.json()).then(data => {
                console.log("saveAcgiFieldConfig RESPONSE", data)
            });
        }

        function loadAcgiFieldConfig(object_type, cb) {
            fetch('/api/acgi-field-config?object_type=' + object_type)
                .then(res => res.json())
                .then(data => {
                    console.log("loadAcgiFieldConfig RESPONSE", data)
                    if (object_type === 'contacts') {
                        acgiFieldConfig = data.config || {};
                    } else if (object_type === 'memberships') {
                        acgiMembershipsFieldConfig = data.config || {};
                    } else if (object_type === 'orders') {
                        acgiOrdersFieldConfig = data.config || {};
                    } else if (object_type === 'events') {
                        acgiEventsFieldConfig = data.config || {};
                    }

                    if (cb) cb();
                });
        }

        // On page load, load last ACGI fields and config
        window.addEventListener('DOMContentLoaded', function () {
            fetch('/api/acgi-fields?object_type=contacts')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.fields && Object.keys(data.fields).length > 0) {
                        acgiFields = ensureAcgiFieldsObject(data.fields);
                        showAcgiJson(acgiFields);
                        loadAcgiFieldConfig('contacts', () => {
                            loadAddressPreferences(acgiFields.addresses);
                            loadEmailPreference(acgiFields.emails);
                            loadPhonePreference(acgiFields.phones);
                            renderAcgiFields(acgiFields, acgiFieldConfig);
                            // If mode is criteria, repopulate property dropdown
                            const mode = document.querySelector('input[name="addressPreferenceMode"]:checked').value;
                            if (mode === 'criteria' && acgiFields && Array.isArray(acgiFields.addresses)) {
                                populateAddressPropertiesDropdown(acgiFields.addresses);
                            }
                        });
                    }
                });

            fetch('/api/acgi-fields?object_type=memberships')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.fields && Object.keys(data.fields).length > 0) {
                        acgiMemberships = ensureAcgiFieldsObject(data.fields);
                        showAcgiMembershipsJson(acgiMemberships);
                        loadAcgiFieldConfig('memberships', () => {
                            renderAcgiMembershipsFields(acgiMemberships, acgiMembershipsFieldConfig);
                        });
                    }
                });

            fetch('/api/acgi-fields?object_type=orders')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.fields && Object.keys(data.fields).length > 0) {
                        acgiOrders = ensureAcgiFieldsObject(data.fields);
                        showAcgiOrdersJson(acgiOrders);
                        loadAcgiFieldConfig('orders', () => {
                            renderAcgiOrdersFields(acgiOrders, acgiOrdersFieldConfig);
                        });
                    }
                });

            fetch('/api/acgi-fields?object_type=events')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.fields && Object.keys(data.fields).length > 0) {
                        acgiEvents = ensureAcgiFieldsObject(data.fields);
                        showAcgiEventsJson(acgiEvents);
                        loadAcgiFieldConfig('events', () => {
                            renderAcgiEventsFields(acgiEvents, acgiEventsFieldConfig);
                        });
                    }
                });

            // Add event listener for membership selector
            document.getElementById('membership-item-selector').addEventListener('change', function() {
                currentMembershipIndex = parseInt(this.value);
                updateMembershipDisplay();
                });

            // Add event listener for events selector
            document.getElementById('events-item-selector').addEventListener('change', function() {
                currentEventsIndex = parseInt(this.value);
                updateEventsDisplay();
                });
        });

        // After fetching a customer, save the field list
        function fetchAcgiCustomer() {
            const customerId = document.getElementById('acgi-customer-id').value;
            if (!customerId) return;
            document.getElementById('acgi-loading-spinner').style.display = 'block';
            document.getElementById('fetch-acgi-btn').disabled = true;
            fetch(`/api/acgi/customer/${customerId}`)
                .then(response => response.json())
                .then(data => {
                    acgiFields = ensureAcgiFieldsObject(data.fields);
                    // Store ACGI fields globally for mapping
                    acgiContactFields = acgiFields;
                    showAcgiJson(acgiFields);
                    // Save the field list to backend
                    fetch('/api/acgi-fields', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ object_type: 'contacts', fields: acgiFields })
                    });
                    loadAcgiFieldConfig('contacts', () => {
                        updateCurrentAddressPreference(() => {
                            updateCurrentEmailPreference(() => {
                                updateCurrentPhonePreference(() => {
                                    renderAcgiFields(acgiFields, acgiFieldConfig);
                                    // If mode is criteria, repopulate property dropdown
                                    const mode = document.querySelector('input[name="addressPreferenceMode"]:checked').value;
                                    if (mode === 'criteria' && acgiFields && Array.isArray(acgiFields.addresses)) {
                                        populateAddressPropertiesDropdown(acgiFields.addresses);
                                    }
                                    // Generate and save mapping based on current order
                                    if (propertiesData['contacts']) {
                                        saveMappingSilently('contacts');
                                    }
                                });
                            });
                        });
                    });
                    document.getElementById('acgi-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-acgi-btn').disabled = false;
                })
                .catch(error => {
                    console.log("error", error)
                    document.getElementById('acgi-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-acgi-btn').disabled = false;
                    let msg = 'Failed to fetch ACGI customer data.';
                    document.getElementById('acgiImportantFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                    document.getElementById('acgiAllFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                });
        }
        function fetchAcgiCustomerMemberships() {
            const customerId = document.getElementById('acgi-membership-customer-id').value;
            if (!customerId) return;
            document.getElementById('acgi-membership-loading-spinner').style.display = 'block';
            document.getElementById('fetch-memberships-btn').disabled = false;
            fetch(`/api/acgi/customer/${customerId}/memberships`)
                .then(response => response.json())
                .then(data => {
                    console.log("data", data)
                    let memberships_data = data.fields
                    
                    // Store the full list of memberships
                    if (Array.isArray(memberships_data)) {
                        acgiMembershipsList = memberships_data;
                        acgiMemberships = ensureAcgiFieldsObject(memberships_data[0]);
                    } else {
                        acgiMembershipsList = [memberships_data];
                        acgiMemberships = ensureAcgiFieldsObject(memberships_data);
                    }
                    
                    // Store ACGI membership fields globally for mapping
                    acgiMembershipFields = acgiMemberships;
                    
                    // Populate the membership selector
                    populateMembershipSelector(acgiMembershipsList);
                    
                    showAcgiMembershipsJson(memberships_data);
                    // Save the field list to backend
                    console.log("acgiMemberships TTTT", acgiMemberships)
                    fetch('/api/acgi-fields', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ object_type: 'memberships', fields: acgiMemberships })
                    });
                    loadAcgiFieldConfig('memberships', () => {
                        renderAcgiMembershipsFields(acgiMemberships, acgiMembershipsFieldConfig);
                        // Generate and save mapping based on current order
                        if (propertiesData['memberships']) {
                            saveMappingSilently('memberships');
                        }
                    });
                    console.log("acgiMemberships", acgiMemberships)
                    document.getElementById('acgi-membership-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-memberships-btn').disabled = false;
                }).catch(error => {
                    console.log("error", error)
                    document.getElementById('acgi-membership-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-memberships-btn').disabled = false;
                    let msg = 'Failed to fetch ACGI customer memberships.';
                    document.getElementById('membershipACGIImportantFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                    document.getElementById('membershipACGIAllFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                });
        }
        
        function fetchAcgiCustomerProducts() {
            const customerId = document.getElementById('acgi-products-customer-id').value;
            if (!customerId) return;
            document.getElementById('acgi-products-loading-spinner').style.display = 'block';
            document.getElementById('fetch-products-btn').disabled = false;
            fetch(`/api/acgi/customer/${customerId}/purchased-products`)
                .then(response => response.json())
                .then(data => {
                    console.log("CustomerProducts data", data)
                    let products_data = data.fields
                    
                    // Store the full list of products
                    if (Array.isArray(products_data)) {
                        acgiProductsList = products_data;
                        acgiProducts = ensureAcgiFieldsObject(products_data[0]);
                    } else {
                        acgiProductsList = [products_data];
                        acgiProducts = ensureAcgiFieldsObject(products_data);
                    }
                    
                    // Store ACGI products fields globally for mapping
                    acgiProductsFields = acgiProducts;
                    
                    // Populate the products selector
                    populateProductsSelector(acgiProductsList);
                    
                    showAcgiOrdersJson(products_data);
                    // Save the field list to backend
                    console.log("acgiProducts TTTT", acgiProducts)
                    fetch('/api/acgi-fields', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ object_type: 'orders', fields: acgiProducts })
                    });
                    loadAcgiFieldConfig('orders', () => {
                        renderAcgiOrdersFields(acgiProducts, acgiProductsFieldConfig);
                        // Generate and save mapping based on current order
                        if (propertiesData['orders']) {
                            saveMappingSilently('orders');
                        }
                    });
                    console.log("acgiProducts", acgiProducts)
                    document.getElementById('acgi-products-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-products-btn').disabled = false;
                }).catch(error => {
                    console.log("error", error)
                    document.getElementById('acgi-products-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-products-btn').disabled = false;
                    let msg = 'Failed to fetch ACGI customer products.';
                    document.getElementById('productsACGIImportantFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                    document.getElementById('productsACGIAllFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                });
        }
        
        function fetchAcgiCustomerEvents() {
            const customerId = document.getElementById('acgi-events-customer-id').value;
            if (!customerId) return;
            document.getElementById('acgi-events-loading-spinner').style.display = 'block';
            document.getElementById('fetch-events-btn').disabled = false;
            fetch(`/api/acgi/customer/${customerId}/events`)
                .then(response => response.json())
                .then(data => {
                    console.log("events data", data)
                    let events_data = data.fields
                    
                    // Store the full list of events
                    if (Array.isArray(events_data)) {
                        acgiEventsList = events_data;
                        acgiEvents = ensureAcgiFieldsObject(events_data[0]);
                    } else {
                        acgiEventsList = [events_data];
                        acgiEvents = ensureAcgiFieldsObject(events_data);
                    }
                    
                    // Store ACGI events fields globally for mapping
                    acgiEventsFields = acgiEvents;
                    
                    // Populate the events selector
                    populateEventsSelector(acgiEventsList);
                    
                    showAcgiEventsJson(events_data);
                    // Save the field list to backend
                    console.log("acgiEvents TTTT", acgiEvents)
                    fetch('/api/acgi-fields', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ object_type: 'events', fields: acgiEvents })
                    });
                    loadAcgiFieldConfig('events', () => {
                        renderAcgiEventsFields(acgiEvents, acgiEventsFieldConfig);
                        // Generate and save mapping based on current order
                        if (propertiesData['events']) {
                            saveMappingSilently('events');
                        }
                    });
                    console.log("acgiEvents", acgiEvents)
                    document.getElementById('acgi-events-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-events-btn').disabled = false;
                }).catch(error => {
                    console.log("error", error)
                    document.getElementById('acgi-events-loading-spinner').style.display = 'none';
                    document.getElementById('fetch-events-btn').disabled = false;
                    let msg = 'Failed to fetch ACGI customer events.';
                    document.getElementById('eventsACGIImportantFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                    document.getElementById('eventsACGIAllFields').innerHTML = `<div class='alert alert-danger text-center'>${msg}</div>`;
                });
        }
        
        // Address Preferences logic (radio version)
        function showHideCriteriaSectionRadio() {
            const mode = document.querySelector('input[name="addressPreferenceMode"]:checked').value;
            document.getElementById('address-criteria-section').style.display = (mode === 'criteria') ? '' : 'none';
            if (mode === 'criteria' && acgiFields && Array.isArray(acgiFields.addresses)) {
                const propertySelect = document.getElementById('address-criteria-property');
                if (propertySelect.options.length === 0) {
                    populateAddressPropertiesDropdown(acgiFields.addresses);
                }
            }
        }
        document.querySelectorAll('input[name="addressPreferenceMode"]').forEach(radio => {
            radio.addEventListener('change', showHideCriteriaSectionRadio);
        });

        document.getElementById('address-preferences-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const mode = document.querySelector('input[name="addressPreferenceMode"]:checked').value;
            const format = document.querySelector('input[name="addressFormat"]:checked').value;
            let preference = { mode, format };
            if (mode === 'criteria') {
                preference.property = document.getElementById('address-criteria-property').value;
                preference.operator = document.getElementById('address-criteria-operator').value;
                preference.value = document.getElementById('address-criteria-value').value;
            }
            currentAddressPreference = preference;
            fetch('/api/acgi-address-preference', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ object_type: 'contacts', preference })
            }).then(() => {
                alert('Address preferences saved!');
            });
            renderAcgiFields(acgiFields, acgiFieldConfig);
        });

        // When loading preferences, set the format radio button
        function loadAddressPreferences(addresses) {
            fetch('/api/acgi-address-preference?object_type=contacts')
                .then(res => res.json().catch(() => ({ success: false })))
                .then(data => {
                    let pref = data && data.preference ? data.preference : {};
                    if (!pref.mode) pref.mode = 'first';
                    if (!pref.format) pref.format = 'json';

                    document.getElementById('addressModeFirst').checked = pref.mode === 'first';
                    document.getElementById('addressModeLast').checked = pref.mode === 'last';
                    document.getElementById('addressModeCriteria').checked = pref.mode === 'criteria';
                    document.getElementById('addressFormatJson').checked = pref.format === 'json';
                    document.getElementById('addressFormatFlat').checked = pref.format === 'flat';

                    currentAddressPreference = pref;

                    attachAddressPreferenceRadioListeners();
                    showHideCriteriaSectionRadio();

                    if (pref.mode === 'criteria' && addresses && addresses.length > 0) {
                        populateAddressPropertiesDropdown(addresses);
                        document.getElementById('address-criteria-property').value = pref.property || '';
                        document.getElementById('address-criteria-operator').value = pref.operator || '=';
                        document.getElementById('address-criteria-value').value = pref.value || '';
                    }

                    renderAcgiFields(acgiFields, acgiFieldConfig);
                });
        }

        // Attach radio event listeners after DOM is ready
        function attachAddressPreferenceRadioListeners() {
            document.querySelectorAll('input[name="addressPreferenceMode"]').forEach(radio => {
                radio.removeEventListener('change', showHideCriteriaSectionRadio); // Remove if already attached
                radio.addEventListener('change', showHideCriteriaSectionRadio);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            attachAddressPreferenceRadioListeners();
        });

        // When address preference changes, update and re-render
        function onAddressPreferenceChange() {
            updateCurrentAddressPreference(() => {
                renderAcgiFields(acgiFields, acgiFieldConfig);
            });
        }
        document.querySelectorAll('input[name="addressPreferenceMode"]').forEach(radio => {
            radio.addEventListener('change', onAddressPreferenceChange);
        });
        document.getElementById('address-preferences-form').addEventListener('submit', function (e) {
            setTimeout(onAddressPreferenceChange, 100); // update after save
        });

        // Defensive parsing for acgiFields if it is a string
        function ensureAcgiFieldsObject(fields) {
            if (typeof fields === 'string') {
                try {
                    fields = JSON.parse(fields);
                } catch (e) {
                    console.error('Failed to parse acgiFields:', fields);
                    fields = {};
                }
            }
            return fields;
        }

        function populateAddressPropertiesDropdown(addresses) {
            const propertySelect = document.getElementById('address-criteria-property');
            if (!addresses || addresses.length === 0) return;
            const newKeys = Object.keys(addresses[0]);
            const currentOptions = Array.from(propertySelect.options).map(opt => opt.value);
            // Only repopulate if empty or keys have changed
            const keysChanged = newKeys.length !== currentOptions.length || newKeys.some((k, i) => k !== currentOptions[i]);
            if (propertySelect.options.length === 0 || keysChanged) {
                const prevValue = propertySelect.value;
                propertySelect.innerHTML = '';
                newKeys.forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = key;
                    propertySelect.appendChild(opt);
                });
                // Restore previous value if still valid
                if (prevValue && newKeys.includes(prevValue)) {
                    propertySelect.value = prevValue;
                }
            }
        }

        // When format preference changes, update and re-render
        function onAddressFormatChange() {
            const format = document.querySelector('input[name="addressFormat"]:checked').value;
            currentAddressPreference.format = format;
            renderAcgiFields(acgiFields, acgiFieldConfig);
        }
        document.querySelectorAll('input[name="addressFormat"]').forEach(radio => {
            radio.addEventListener('change', onAddressFormatChange);
        });

        // Copy To HubSpot logic
        function copyAcgiToHubspot(object_type) {
            // 1. Get ordered ACGI important fields
            let acgiCards = document.querySelectorAll('#acgiImportantFields .property-card');
            if (object_type === 'memberships') {
                acgiCards = document.querySelectorAll('#membershipACGIImportantFields .property-card');
            } else if (object_type === 'orders') {
                acgiCards = document.querySelectorAll('#ordersACGIImportantFields .property-card');
            } else if (object_type === 'events') {
                acgiCards = document.querySelectorAll('#eventsACGIImportantFields .property-card');
            }
            // 2. Get ordered enabled HubSpot important fields (as rendered in the form)
            let hubspotForm = document.getElementById('contactsForm');
            if (object_type === 'memberships') {
                hubspotForm = document.getElementById('membershipsForm');   
            } else if (object_type === 'orders') {
                hubspotForm = document.getElementById('ordersForm');
            } else if (object_type === 'events') {
                hubspotForm = document.getElementById('eventsForm');
            }
            
            // Find all enabled fields in the form (inputs, selects, textareas)
            const hubspotInputs = Array.from(hubspotForm.querySelectorAll('.form-row input, .form-row select, .form-row textarea'))
                .filter(input => !input.disabled && input.offsetParent !== null); // visible and enabled

            // 3. Copy by order
            acgiCards.forEach((card, idx) => {
                if (idx >= hubspotInputs.length) return;
                const valueDiv = card.querySelector('.property-label');
                let value = valueDiv ? valueDiv.textContent : '';
                const input = hubspotInputs[idx];
                console.log(`Copying ACGI field #${idx + 1} value:`, value, 'to HubSpot input:', input);

                // Convert value based on input type
                let convertedValue = value;
                
                // Handle date and datetime fields
                if (input.getAttribute('data-field-type') === 'date' || input.type === 'date') {
                    convertedValue = convertToDateInputFormat(value);
                } else if (input.getAttribute('data-field-type') === 'datetime' || input.type === 'datetime-local') {
                    convertedValue = convertToDateTimeInputFormat(value);
                }

                if (input.tagName === 'SELECT') {
                    if ([...input.options].some(opt => opt.value === convertedValue)) {
                        input.value = convertedValue;
                    } else {
                        input.selectedIndex = 0;
                    }
                } else if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = !!convertedValue;
                } else {
                    input.value = convertedValue;
                }
                input.dispatchEvent(new Event('input', { bubbles: true }));
            });
        }

        // Helper function to convert various date formats to HTML date input format (yyyy-MM-dd)
        function convertToDateInputFormat(value) {
            if (!value || value.trim() === '') return '';
            
            try {
                // Try to parse the value as a date
                let date;
                
                // Handle different possible formats
                if (typeof value === 'number' || /^\d+$/.test(value)) {
                    // Unix timestamp (seconds or milliseconds)
                    const timestamp = parseInt(value);
                    date = new Date(timestamp > 1000000000000 ? timestamp : timestamp * 1000);
                } else if (value.includes('T') || value.includes('Z')) {
                    // ISO string format
                    date = new Date(value);
                } else if (value.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                    // Handle mm/dd/yyyy format from ACGI
                    const parts = value.split('/');
                    const month = parseInt(parts[0]) - 1; // Month is 0-indexed in Date constructor
                    const day = parseInt(parts[1]);
                    const year = parseInt(parts[2]);
                    date = new Date(year, month, day);
                } else {
                    // Try parsing as regular date string
                    date = new Date(value);
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Could not parse date value:', value);
                    return value; // Return original value if parsing fails
                }
                
                // Format as yyyy-MM-dd for HTML date input
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (error) {
                console.warn('Error converting date value:', value, error);
                return value; // Return original value if conversion fails
            }
        }

        // Helper function to convert various date formats to HTML datetime-local input format (YYYY-MM-DDTHH:MM)
        function convertToDateTimeInputFormat(value) {
            if (!value || value.trim() === '') return '';
            
            try {
                // Try to parse the value as a date
                let date;
                
                // Handle different possible formats
                if (typeof value === 'number' || /^\d+$/.test(value)) {
                    // Unix timestamp (seconds or milliseconds)
                    const timestamp = parseInt(value);
                    date = new Date(timestamp > 1000000000000 ? timestamp : timestamp * 1000);
                } else if (value.includes('T') || value.includes('Z')) {
                    // ISO string format
                    date = new Date(value);
                } else {
                    // Try parsing as regular date string
                    date = new Date(value);
                }
                
                if (isNaN(date.getTime())) {
                    console.warn('Could not parse datetime value:', value);
                    return value; // Return original value if parsing fails
                }
                
                // Format as YYYY-MM-DDTHH:MM for HTML datetime-local input
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            } catch (error) {
                console.warn('Error converting datetime value:', value, error);
                return value; // Return original value if conversion fails
            }
        }
        document.getElementById('copyToHubspotBtn').addEventListener('click', () => copyAcgiToHubspot('contacts'));
        document.getElementById('copyMembershipsToHubspotBtn').addEventListener('click', () => copyAcgiToHubspot('memberships'));
        document.getElementById('copyOrdersToHubspotBtn').addEventListener('click', () => copyAcgiToHubspot('orders'));
        document.getElementById('copyEventsToHubspotBtn').addEventListener('click', () => copyAcgiToHubspot('events'));
        // --- Email and Phone Preferences Logic ---

        function selectItemByPreference(list, preference) {
            if (!Array.isArray(list) || list.length === 0) return null;
            if (!preference || !preference.mode || preference.mode === 'first') {
                return list[0];
            }
            if (preference.mode === 'last') {
                return list[list.length - 1];
            }
            if (preference.mode === 'criteria' && preference.property && preference.operator) {
                return list.find(item => {
                    const val = item[preference.property];
                    const cmp = preference.value;
                    switch (preference.operator) {
                        case '=':
                            if (typeof val === 'boolean') return val === (cmp === 'true');
                            if (typeof val === 'number') return val === Number(cmp);
                            return val == cmp;
                        case '!=':
                            if (typeof val === 'boolean') return val !== (cmp === 'true');
                            if (typeof val === 'number') return val !== Number(cmp);
                            return val != cmp;
                        case 'contains': return val && typeof val === 'string' && val.includes(cmp);
                        case '>': return val > cmp;
                        case '<': return val < cmp;
                        case 'is null': return val === null || val === undefined;
                        case 'is not null': return val !== null && val !== undefined;
                        default: return false;
                    }
                }) || null;
            }
            return list[0];
        }

        function formatEmailFlat(emailObj) {
            return emailObj && emailObj.address ? emailObj.address : '';
        }
        function formatPhoneFlat(phoneObj) {
            return phoneObj && phoneObj.number ? phoneObj.number : '';
        }

        // Save/load preferences for email and phone
        function saveEmailPreference(preference) {
            fetch('/api/acgi-email-preference', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ object_type: 'contacts', preference })
            });
        }
        function savePhonePreference(preference) {
            fetch('/api/acgi-phone-preference', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ object_type: 'contacts', preference })
            });
        }
        function loadEmailPreference(emails) {
            fetch('/api/acgi-email-preference?object_type=contacts')
                .then(res => res.json().catch(() => ({ success: false })))
                .then(data => {
                    let pref = data && data.preference ? data.preference : {};
                    if (!pref.mode) pref.mode = 'first';
                    if (!pref.format) pref.format = 'json';

                    document.getElementById('emailModeFirst').checked = pref.mode === 'first';
                    document.getElementById('emailModeLast').checked = pref.mode === 'last';
                    document.getElementById('emailModeCriteria').checked = pref.mode === 'criteria';
                    document.getElementById('emailFormatJson').checked = pref.format === 'json';
                    document.getElementById('emailFormatFlat').checked = pref.format === 'flat';

                    currentEmailPreference = pref;

                    attachEmailPreferenceRadioListeners();
                    showHideEmailCriteriaSection();

                    if (pref.mode === 'criteria' && emails && emails.length > 0) {
                        populateEmailPropertiesDropdown(emails);
                        document.getElementById('email-criteria-property').value = pref.property || '';
                        document.getElementById('email-criteria-operator').value = pref.operator || '=';
                        document.getElementById('email-criteria-value').value = pref.value || '';
                    }

                    renderAcgiFields(acgiFields, acgiFieldConfig);
                });
        }
        function loadPhonePreference(phones) {
            fetch('/api/acgi-phone-preference?object_type=contacts')
                .then(res => res.json().catch(() => ({ success: false })))
                .then(data => {
                    let pref = data && data.preference ? data.preference : {};
                    if (!pref.mode) pref.mode = 'first';
                    if (!pref.format) pref.format = 'json';

                    document.getElementById('phoneModeFirst').checked = pref.mode === 'first';
                    document.getElementById('phoneModeLast').checked = pref.mode === 'last';
                    document.getElementById('phoneModeCriteria').checked = pref.mode === 'criteria';
                    document.getElementById('phoneFormatJson').checked = pref.format === 'json';
                    document.getElementById('phoneFormatFlat').checked = pref.format === 'flat';

                    currentPhonePreference = pref;

                    attachPhonePreferenceRadioListeners();
                    showHidePhoneCriteriaSection();

                    if (pref.mode === 'criteria' && phones && phones.length > 0) {
                        populatePhonePropertiesDropdown(phones);
                        document.getElementById('phone-criteria-property').value = pref.property || '';
                        document.getElementById('phone-criteria-operator').value = pref.operator || '=';
                        document.getElementById('phone-criteria-value').value = pref.value || '';
                    }

                    renderAcgiFields(acgiFields, acgiFieldConfig);
                });
        }

        // Show/hide criteria sections for email/phone
        function showHideEmailCriteriaSection() {
            const mode = document.querySelector('input[name="emailPreferenceMode"]:checked').value;
            document.getElementById('email-criteria-section').style.display = (mode === 'criteria') ? '' : 'none';
        }
        function showHidePhoneCriteriaSection() {
            const mode = document.querySelector('input[name="phonePreferenceMode"]:checked').value;
            document.getElementById('phone-criteria-section').style.display = (mode === 'criteria') ? '' : 'none';
        }
        function attachEmailPreferenceRadioListeners() {
            document.querySelectorAll('input[name="emailPreferenceMode"]').forEach(radio => {
                radio.removeEventListener('change', showHideEmailCriteriaSection);
                radio.addEventListener('change', showHideEmailCriteriaSection);
            });
        }
        function attachPhonePreferenceRadioListeners() {
            document.querySelectorAll('input[name="phonePreferenceMode"]').forEach(radio => {
                radio.removeEventListener('change', showHidePhoneCriteriaSection);
                radio.addEventListener('change', showHidePhoneCriteriaSection);
            });
        }
        // Populate property dropdowns for email/phone
        function populateEmailPropertiesDropdown(emails) {
            const propertySelect = document.getElementById('email-criteria-property');
            propertySelect.innerHTML = '';
            if (emails && emails.length > 0) {
                Object.keys(emails[0]).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = key;
                    propertySelect.appendChild(opt);
                });
            }
        }
        function populatePhonePropertiesDropdown(phones) {
            const propertySelect = document.getElementById('phone-criteria-property');
            propertySelect.innerHTML = '';
            if (phones && phones.length > 0) {
                Object.keys(phones[0]).forEach(key => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.textContent = key;
                    propertySelect.appendChild(opt);
                });
            }
        }

        // When email preference changes, update and re-render
        function onEmailPreferenceChange() {
            const mode = document.querySelector('input[name="emailPreferenceMode"]:checked').value;
            const format = document.querySelector('input[name="emailFormat"]:checked').value;
            currentEmailPreference = { mode, format };
            renderAcgiFields(acgiFields, acgiFieldConfig);
        }
        function onEmailFormatChange() {
            const format = document.querySelector('input[name="emailFormat"]:checked').value;
            currentEmailPreference.format = format;
            renderAcgiFields(acgiFields, acgiFieldConfig);
        }
        document.querySelectorAll('input[name="emailPreferenceMode"]').forEach(radio => {
            radio.addEventListener('change', onEmailPreferenceChange);
        });
        document.querySelectorAll('input[name="emailFormat"]').forEach(radio => {
            radio.addEventListener('change', onEmailFormatChange);
        });

        // When phone preference changes, update and re-render
        function onPhonePreferenceChange() {
            const mode = document.querySelector('input[name="phonePreferenceMode"]:checked').value;
            const format = document.querySelector('input[name="phoneFormat"]:checked').value;
            currentPhonePreference = { mode, format };
            renderAcgiFields(acgiFields, acgiFieldConfig);
        }
        function onPhoneFormatChange() {
            const format = document.querySelector('input[name="phoneFormat"]:checked').value;
            currentPhonePreference.format = format;
            renderAcgiFields(acgiFields, acgiFieldConfig);
        }
        document.querySelectorAll('input[name="phonePreferenceMode"]').forEach(radio => {
            radio.addEventListener('change', onPhonePreferenceChange);
        });
        document.querySelectorAll('input[name="phoneFormat"]').forEach(radio => {
            radio.addEventListener('change', onPhoneFormatChange);
        });

        // Save preference forms
        document.getElementById('email-preferences-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const mode = document.querySelector('input[name="emailPreferenceMode"]:checked').value;
            const format = document.querySelector('input[name="emailFormat"]:checked').value;
            let preference = { mode, format };
            if (mode === 'criteria') {
                preference.property = document.getElementById('email-criteria-property').value;
                preference.operator = document.getElementById('email-criteria-operator').value;
                preference.value = document.getElementById('email-criteria-value').value;
            }
            currentEmailPreference = preference;
            saveEmailPreference(preference);
            renderAcgiFields(acgiFields, acgiFieldConfig);
        });
        document.getElementById('phone-preferences-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const mode = document.querySelector('input[name="phonePreferenceMode"]:checked').value;
            const format = document.querySelector('input[name="phoneFormat"]:checked').value;
            let preference = { mode, format };
            if (mode === 'criteria') {
                preference.property = document.getElementById('phone-criteria-property').value;
                preference.operator = document.getElementById('phone-criteria-operator').value;
                preference.value = document.getElementById('phone-criteria-value').value;
            }
            currentPhonePreference = preference;
            savePhonePreference(preference);
            renderAcgiFields(acgiFields, acgiFieldConfig);
        });

        // Email preference change listeners
        document.querySelectorAll('input[name="emailPreferenceMode"]').forEach(radio => {
            radio.addEventListener('change', function () {
                showHideEmailCriteriaSection();
                onEmailPreferenceChange();
            });
        });
        document.querySelectorAll('input[name="emailFormat"]').forEach(radio => {
            radio.addEventListener('change', onEmailFormatChange);
        });

        // Phone preference change listeners
        document.querySelectorAll('input[name="phonePreferenceMode"]').forEach(radio => {
            radio.addEventListener('change', function () {
                showHidePhoneCriteriaSection();
                onPhonePreferenceChange();
            });
        });
        document.querySelectorAll('input[name="phoneFormat"]').forEach(radio => {
            radio.addEventListener('change', onPhoneFormatChange);
        });

        


                // Mapping is now generated automatically by the backend
        // The backend reads field configurations from the database and creates the mapping

        function saveMappingSilently(objectType) {
            console.log(`Silently saving ${objectType} mapping...`);

            const EndpointForObject = {
                "contacts": "/api/mapping/contact",
                "memberships": "/api/mapping/membership",
                "events": "/api/mapping/event",
                "orders": "/api/mapping/order"
            }
            
            const endpoint = EndpointForObject[objectType];
            console.log(`Sending request to endpoint: ${endpoint}`);
            
            // Backend will automatically generate mapping from current field configurations
            fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}) // No mapping data needed - backend generates it
            })
            .then(response => {
                console.log(`Response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                console.log(`${objectType} mapping saved silently:`, data);
                if (data.mapping) {
                    console.log(`Generated mapping:`, data.mapping);
                    // Update the global mapping variable
                    if (objectType === 'contacts') {
                        contactsMapping = data.mapping;
                    } else if (objectType === 'memberships') {
                        membershipsMapping = data.mapping;
                    }
                }
                // Show a brief success message
                showAlert(`${objectType} mapping updated automatically!`, 'success');
            })
            .catch(error => {
                console.error(`Error saving ${objectType} mapping silently:`, error);
                showAlert(`Error updating ${objectType} mapping: ${error.message}`, 'danger');
            });
        }

        function testMapping() {
            console.log('=== TESTING MAPPING ===');
            console.log('ACGI Contact Fields:', acgiContactFields);
            console.log('ACGI Membership Fields:', acgiMembershipFields);
            console.log('Properties Data:', propertiesData);
            console.log('Current Contacts Mapping:', contactsMapping);
            console.log('Current Memberships Mapping:', membershipsMapping);
            
            // Test saving - backend will generate mappings automatically
            saveMappingSilently('contacts');
            saveMappingSilently('memberships');
        }

        function forceSaveMapping() {
            console.log('=== FORCE SAVE MAPPING ===');
            console.log('Forcing mapping save for both contacts and memberships...');
            
            // Backend will automatically generate mappings from database configurations
            console.log('Saving contacts mapping...');
            saveMappingSilently('contacts');
            
            console.log('Saving memberships mapping...');
            saveMappingSilently('memberships');
        }

        function refreshMappingsFromDatabase() {
            console.log('=== REFRESHING MAPPINGS FROM DATABASE ===');
            
            // Load mappings from database
            loadMapping('contacts');
            loadMapping('memberships');
            
            // Show success message
            showAlert('Mappings refreshed from database!', 'success');
        }

        function loadMapping(objectType) {
            console.log(`Loading ${objectType} mapping...`);
            
            const endpoint = objectType === 'contacts' ? '/api/mapping/contact' : '/api/mapping/membership';
            
            fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                console.log(`${objectType} mapping loaded:`, data);
                if (objectType === 'contacts') {
                    contactsMapping = data.mapping || {};
                } else if (objectType === 'memberships') {
                    membershipsMapping = data.mapping || {};
                }
                // Generate new mapping based on current order if ACGI fields are available
                if ((objectType === 'contacts' && acgiContactFields) || 
                    (objectType === 'memberships' && acgiMembershipFields)) {
                    const newMapping = generateOrderBasedMapping(objectType);
                    if (Object.keys(newMapping).length > 0) {
                        if (objectType === 'contacts') {
                            contactsMapping = newMapping;
                        } else if (objectType === 'memberships') {
                            membershipsMapping = newMapping;
                        }
                        // Save the new mapping
                        saveMappingSilently(objectType);
                    }
                }
            })
            .catch(error => {
                console.error(`Error loading ${objectType} mapping:`, error);
                if (objectType === 'contacts') {
                    contactsMapping = {};
                } else if (objectType === 'memberships') {
                    membershipsMapping = {};
                }
            });
        }

        
    </script>
</body>

</html>